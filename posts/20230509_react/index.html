<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-05-09">
<meta name="description" content="本文ではAgentの使い方から、インプットからアウトプットまでの流れを説明していきます。AgentExecutorの詳細を徹底的に解説します。">

<title>blog - LangChain Agentの全面解説</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-56TE34D1Z4"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-56TE34D1Z4', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="http://www.linkedin.com/in/jiang-dayuan" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#reactを例にlangchainのagentを紹介する" id="toc-reactを例にlangchainのagentを紹介する" class="nav-link active" data-scroll-target="#reactを例にlangchainのagentを紹介する">ReActを例にLangChainのAgentを紹介する</a></li>
  <li><a href="#カスタマイズのagentを作る" id="toc-カスタマイズのagentを作る" class="nav-link" data-scroll-target="#カスタマイズのagentを作る">カスタマイズのAgentを作る</a></li>
  <li><a href="#agentの動作を説明する" id="toc-agentの動作を説明する" class="nav-link" data-scroll-target="#agentの動作を説明する">Agentの動作を説明する</a>
  <ul class="collapse">
  <li><a href="#ツールを定義する" id="toc-ツールを定義する" class="nav-link" data-scroll-target="#ツールを定義する">ツールを定義する</a></li>
  <li><a href="#promptを定義する" id="toc-promptを定義する" class="nav-link" data-scroll-target="#promptを定義する"><code>prompt</code>を定義する</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">LangChain Agentの全面解説</h1>
  <div class="quarto-categories">
    <div class="quarto-category">NLP</div>
    <div class="quarto-category">LLMs</div>
    <div class="quarto-category">LangChain</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 9, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>LangChainの中に最もハイレベルな概念としてはAgentです。以前の投稿の中でも話ましたが、LangChainはまだ未熟なライブラリなので、Agentの実装は複雑なものになっていますし、中身の挙動を説明するドキュメントもなかったので、本文ではAgentの使い方から、インプットからアウトプットまでの流れを説明していきます。</p>
<section id="reactを例にlangchainのagentを紹介する" class="level2">
<h2 class="anchored" data-anchor-id="reactを例にlangchainのagentを紹介する">ReActを例にLangChainのAgentを紹介する</h2>
<p>LangChainのAgentとは、簡単に言うとツールを利用できるLLMです。</p>
<p>典型の例としては「ReAct」が挙げられます。去年出されている「ReAct: Synergizing Reasoning and Acting in Language Models」の論文の中で、思考だけではなく、思考に基づいて行動を起こし、さらに行動の結果から思考を行うLLMsの利用方法を提案した。そのやり方はReasoningとActingの結合なので、「ReAct」と名付けられました。</p>
<p>実際の例で見ましょう。下記のコードはLangChainで定義したReActのAgentです。このAgentは検索と照応の2つのツールを持っています。人間と同じように、質問が投げられた後、Wikipediaで検査し、検索した結果からコピペー(照応)しながら答案を作ることができます。</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">from</span> langchain <span class="im">import</span> OpenAI, Wikipedia</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">from</span> langchain.agents <span class="im">import</span> initialize_agent, Tool</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="im">from</span> langchain.agents <span class="im">import</span> AgentType</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">from</span> langchain.agents.react.base <span class="im">import</span> DocstoreExplorer</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># set the environment variables</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>load_dotenv()</span>
<span id="cb1-8"><a href="#cb1-8"></a></span>
<span id="cb1-9"><a href="#cb1-9"></a>docstore<span class="op">=</span>DocstoreExplorer(Wikipedia())</span>
<span id="cb1-10"><a href="#cb1-10"></a>tools <span class="op">=</span> [</span>
<span id="cb1-11"><a href="#cb1-11"></a>    Tool(</span>
<span id="cb1-12"><a href="#cb1-12"></a>        name<span class="op">=</span><span class="st">"Search"</span>,</span>
<span id="cb1-13"><a href="#cb1-13"></a>        func<span class="op">=</span>docstore.search,</span>
<span id="cb1-14"><a href="#cb1-14"></a>        description<span class="op">=</span><span class="st">"useful for when you need to ask with search"</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    ),</span>
<span id="cb1-16"><a href="#cb1-16"></a>    Tool(</span>
<span id="cb1-17"><a href="#cb1-17"></a>        name<span class="op">=</span><span class="st">"Lookup"</span>,</span>
<span id="cb1-18"><a href="#cb1-18"></a>        func<span class="op">=</span>docstore.lookup,</span>
<span id="cb1-19"><a href="#cb1-19"></a>        description<span class="op">=</span><span class="st">"useful for when you need to ask with lookup"</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>    )</span>
<span id="cb1-21"><a href="#cb1-21"></a>]</span>
<span id="cb1-22"><a href="#cb1-22"></a></span>
<span id="cb1-23"><a href="#cb1-23"></a>llm <span class="op">=</span> OpenAI(temperature<span class="op">=</span><span class="dv">0</span>, model_name<span class="op">=</span><span class="st">"text-davinci-003"</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a>react <span class="op">=</span> initialize_agent(tools, llm, agent<span class="op">=</span>AgentType.REACT_DOCSTORE, verbose<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>クリントンの奥さんが何をしているかを聞いてみましょう。</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>react.run(<span class="st">"What do Bill Clinton's wife do for a living?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new AgentExecutor chain...
Thought: I need to search Bill Clinton and find his wife, then find what she does for a living.
Action: Search[Bill Clinton]
Observation: William Jefferson Clinton (né Blythe III; born August 19, 1946) is an American politician  who served as the 42nd president of the United States from 1993 to 2001. He previously served as governor of Arkansas from 1979 to 1981 and again from 1983 to 1992, and as attorney general of Arkansas from 1977 to 1979. A member of the Democratic Party, Clinton became known as a New Democrat, as many of his policies reflected a centrist "Third Way" political philosophy. He is the husband of Hillary Clinton, who was a U.S. senator from New York from 2001 to 2009, secretary of state from 2009 to 2013 and the Democratic nominee for president in the 2016 presidential election.
Clinton was born and raised in Arkansas and attended Georgetown University. He received a Rhodes Scholarship to study at University College, Oxford, and later graduated from Yale Law School. He met Hillary Rodham at Yale; they married in 1975. After graduating from law school, Clinton returned to Arkansas and won election as state attorney general, followed by two non-consecutive tenures as Arkansas governor. As governor, he overhauled the state's education system and served as chairman of the National Governors Association. Clinton was elected president in the 1992 presidential election, defeating incumbent Republican president George H. W. Bush and independent businessman Ross Perot. At 46 years old, he became the third-youngest president of the United States and the first president to be born in the Baby Boomer generation.
Clinton presided over the longest period of peacetime economic expansion in American history. He signed into law the North American Free Trade Agreement (NAFTA) and the Violent Crime Control and Law Enforcement Act, but failed to pass his plan for national health care reform. The Republican Party won unified control of Congress for the first time in 40 years in the 1994 elections, but Clinton was still comfortably re-elected in 1996, becoming the first Democrat since Franklin D. Roosevelt to win a second full term. Starting in the mid-1990s, he began an ideological evolution as he became much more conservative in his domestic policy, advocating for and signing the Personal Responsibility and Work Opportunity Act, the State Children's Health Insurance Program and financial deregulation measures. He appointed Ruth Bader Ginsburg and Stephen Breyer to the U.S. Supreme Court. During the last three years of Clinton's presidency, the Congressional Budget Office reported a budget surplus—the first such surplus since 1969. In foreign policy, Clinton ordered U.S. military intervention in the Bosnian and Kosovo wars, eventually signing the Dayton Peace agreement. He also called for the expansion of NATO in Eastern Europe and many former Warsaw Pact members joined NATO during his presidency. Clinton's foreign policy in the Middle East saw him sign the Iraq Liberation Act which gave aid to groups against Saddam Hussein. He also participated in the Oslo I Accord and Camp David Summit to advance the Israeli–Palestinian peace process, and assisted the Northern Ireland peace process.
Clinton's second term was dominated by the Monica Lewinsky scandal, which began in 1996, when he had a sexual relationship with 22-year-old Monica Lewinsky, an intern at the White House. In January 1998, news of the affair made tabloid headlines. This scandal escalated throughout the year, culminating on December 19 when Clinton was impeached by the House of Representatives, becoming the second U.S. president—the first since Andrew Johnson—to be impeached. The two impeachment articles that the House passed were centered around him using the powers of the presidency to obstruct the investigation and lying under oath. In 1999, Clinton's impeachment trial began in the Senate. He was acquitted on both charges as the Senate failed to cast 67 votes against him, which was necessary to meet the two-thirds conviction threshold prescribed by Article I, section 3, clause 6 of the U.S. Constitution.
Clinton left office in 2001 with the joint-highest approval rating of any U.S. president in the modern era, alongside Franklin D. Roosevelt and Ronald Reagan. His presidency has been ranked among the upper tier in historical rankings of U.S. presidents. However, his personal conduct and allegations of sexual assault have made him the subject of substantial scrutiny. Since leaving office, Clinton has been involved in public speaking and humanitarian work. He created the Clinton Foundation to address international causes such as the prevention of HIV/AIDS and global warming. In 2009, he was named the United Nations Special Envoy to Haiti. After the 2010 Haiti earthquake, Clinton and George W. Bush formed the Clinton Bush Haiti Fund. He has remained active in Democratic Party politics, campaigning for his wife's 2008 and 2016 presidential campaigns.
Thought: Bill Clinton's wife is Hillary Clinton. I need to search Hillary Clinton and find what she does for a living.
Action: Search[Hillary Clinton]
Observation: Hillary Diane Rodham Clinton (born October 26, 1947) is an American politician and diplomat who served as the 67th United States secretary of state under president Barack Obama from 2009 to 2013, as a United States senator representing New York from 2001 to 2009, and as the first lady of the United States as the wife of President Bill Clinton from 1993 to 2001. A member of the Democratic Party, she was the party's nominee for president in the 2016 presidential election, becoming the first woman to win a presidential nomination by a major U.S. political party. Clinton won the popular vote, but lost the Electoral College vote, thereby losing the election to Donald Trump.
Raised in the Chicago suburb of Park Ridge, Rodham graduated from Wellesley College in 1969 and earned a Juris Doctor degree from Yale Law School in 1973. After serving as a congressional legal counsel, she moved to Arkansas and married future president Bill Clinton in 1975; the two had met at Yale. In 1977, Clinton co-founded Arkansas Advocates for Children and Families. She was appointed the first female chair of the Legal Services Corporation in 1978 and became the first female partner at Little Rock's Rose Law Firm the following year. The National Law Journal twice listed her as one of the hundred most influential lawyers in America. Clinton was the  First Lady of Arkansas from 1979 to 1981 and again from 1983 to 1992. As the first lady of the United States, Clinton advocated for healthcare reform. In 1994, her major initiative—the Clinton health care plan—failed to gain approval from Congress. In 1997 and 1999, Clinton played a leading role in advocating the creation of the State Children's Health Insurance Program, the Adoption and Safe Families Act, and the Foster Care Independence Act. Clinton advocated for gender equality at the 1995 UN conference on women. Her marital relationship came under public scrutiny during the Lewinsky scandal, which led her to issue a statement that reaffirmed her commitment to the marriage.
In 2000, Clinton was elected as the first female senator from New York and became the first First lady to simultaneously hold elected office, and then the first former First lady to serve in the Senate. She was re-elected in 2006 and chaired the Senate Democratic Steering and Outreach Committee from 2003 to 2007. During her Senate tenure, Clinton advocated for medical benefits for September 11 first responders. She supported the resolution authorizing the Iraq War in 2002, but opposed the surge of U.S. troops in 2007. In 2008, Clinton ran for president but was defeated by eventual winner Barack Obama in the Democratic primaries. Clinton was U.S. Secretary of State in the first term of the Obama administration from 2009 to 2013. During her tenure, Clinton established the Quadrennial Diplomacy and Development Review. She responded to the Arab Spring by advocating military intervention in Libya but was harshly criticized by Republicans for the failure to prevent or adequately respond to the 2012 Benghazi attack. Clinton helped to organize a diplomatic isolation and a regime of international sanctions against Iran in an effort to force it to curtail its nuclear program; this effort eventually led to the multinational JCPOA nuclear agreement in 2015. Her use of a private email server when she was Secretary of State was the subject of intense scrutiny; while no charges were filed against Clinton, the email controversy was the single most covered topic during the 2016 presidential election.
Clinton made a second presidential run in 2016, winning the Democratic nomination, and ran in the general election with Virginia senator Tim Kaine as her running mate. Clinton lost the presidential election to Republican opponent Donald Trump in the Electoral College, despite winning the popular vote by close to 3 million votes. Following her loss, she wrote her third memoir, What Happened, and launched Onward Together, a political action organization dedicated to fundraising for progressive political groups. Since February 2023, she has served on the faculty of the School of International and Public Affairs at Columbia University.
Thought: Hillary Clinton is a politician, diplomat, and lawyer. So the answer is politician, diplomat, and lawyer.
Action: Finish[politician, diplomat, lawyer]

&gt; Finished chain.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>'politician, diplomat, lawyer'</code></pre>
</div>
</div>
<p>ご覧の通り、Agentが質問を受けた後、まず「先にクリントンの奥さんの名前を調べて、それから彼女の仕事を調べる」というプランを立てました。そして、そのプランに基づいて、Wikipediaでまずクリントンを検索し、その結果からヒラリーを特定し、さらにヒラリーの仕事を調べて、答案を作りました。</p>
<p>これで、LangChainのAgentの基本がわかりました。しかし、上記のことはLangChainが実装されているReActをCALLして利用しているだけです。自分でカスタマイズのAgentを作るにはどうすればよいかを、これから説明します。</p>
</section>
<section id="カスタマイズのagentを作る" class="level2">
<h2 class="anchored" data-anchor-id="カスタマイズのagentを作る">カスタマイズのAgentを作る</h2>
<p>Agentは3つの要素から構成されています。</p>
<ul>
<li><code>PromptTemplate</code>: Agentの中の一番コアな部分です。このテンプレートでAgentの挙動を定義します。</li>
<li><code>llm</code>: Agentが利用するLLMです。</li>
<li><code>OutptParser</code>: LLMのアウトプットを解析し、AgentActionもしくはAgentFinishを生成するモジュールです。</li>
</ul>
<p>作られたAgentは<code>AgentExecutor</code>を通じで、以下のステップで実行します。</p>
<ol type="1">
<li>ユーザー入力とそれまでのステップをエージェントに渡す。</li>
<li>エージェントが<code>AgentFinish</code>を返す場合、それを直接結果に返す。</li>
<li>Agentが<code>AgentAction</code>を返した場合、それを使ってツールを呼び出し、Observationを取得します。</li>
<li><code>AgentFinish</code>が返されるまで、<code>AgentAction</code>と<code>Observation</code>をAgentに戻すことを繰り返します。</li>
</ol>
<p>これから実際にカスタマイズ的なAgentを作りましょう。</p>
<p>このAgentは「Search」のツールでDBから情報を取得し、質問に答えることができます。 DBの中で「Hiroko」さんの家族に関する情報が入っています。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>corpus <span class="op">=</span> [</span>
<span id="cb5-2"><a href="#cb5-2"></a>    <span class="st">"takuma is a teacher"</span>,</span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="st">"hiroko's father is takuma"</span>,</span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="st">"hiroko's mather is ayako"</span>,</span>
<span id="cb5-5"><a href="#cb5-5"></a>    <span class="st">"ayako is a doctor"</span>,</span>
<span id="cb5-6"><a href="#cb5-6"></a>    <span class="st">"hiroko is 10 years old"</span>,</span>
<span id="cb5-7"><a href="#cb5-7"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>コードが100行ぐらいあります。こからステップ・バイ・ステップで説明するのでなので、一旦折りたたみます。下の矢印をクリックすると、コードが表示されます。</p>
<div class="cell" data-execution_count="69">
<details>
<summary>Click here to show the agent definition code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">from</span> langchain <span class="im">import</span> OpenAI, LLMChain</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">from</span> langchain.agents <span class="im">import</span> Tool, AgentExecutor, LLMSingleActionAgent, AgentOutputParser</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">from</span> langchain.schema <span class="im">import</span> AgentAction, AgentFinish</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> StringPromptTemplate</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="im">from</span> typing <span class="im">import</span> List, Union</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="im">import</span> re</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="im">from</span> dotenv <span class="im">import</span> load_dotenv</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># set the environment variables</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>load_dotenv()</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="im">from</span> langchain.embeddings.openai <span class="im">import</span> OpenAIEmbeddings</span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="im">from</span> langchain.vectorstores <span class="im">import</span> FAISS</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a>corpus <span class="op">=</span> [</span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="st">"takuma is a teacher"</span>,</span>
<span id="cb6-16"><a href="#cb6-16"></a>    <span class="st">"hiroko's father is takuma"</span>,</span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="st">"hiroko's mather is ayako"</span>,</span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="st">"ayako is a doctor"</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>    <span class="st">"hiroko is 10 years old"</span>,</span>
<span id="cb6-20"><a href="#cb6-20"></a>]</span>
<span id="cb6-21"><a href="#cb6-21"></a>        </span>
<span id="cb6-22"><a href="#cb6-22"></a>embedding <span class="op">=</span> OpenAIEmbeddings()</span>
<span id="cb6-23"><a href="#cb6-23"></a>vectorstore <span class="op">=</span> FAISS.from_texts(corpus, embedding)</span>
<span id="cb6-24"><a href="#cb6-24"></a></span>
<span id="cb6-25"><a href="#cb6-25"></a>tools <span class="op">=</span> [</span>
<span id="cb6-26"><a href="#cb6-26"></a>    Tool(</span>
<span id="cb6-27"><a href="#cb6-27"></a>        name<span class="op">=</span><span class="st">"Search"</span>,</span>
<span id="cb6-28"><a href="#cb6-28"></a>        func<span class="op">=</span> <span class="kw">lambda</span> query: vectorstore.similarity_search(query, top_k<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].page_content,</span>
<span id="cb6-29"><a href="#cb6-29"></a>        description<span class="op">=</span><span class="st">"useful for when you need to ask with search"</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>    ),</span>
<span id="cb6-31"><a href="#cb6-31"></a>]</span>
<span id="cb6-32"><a href="#cb6-32"></a></span>
<span id="cb6-33"><a href="#cb6-33"></a>tool_names <span class="op">=</span> [tool.name <span class="cf">for</span> tool <span class="kw">in</span> tools]</span>
<span id="cb6-34"><a href="#cb6-34"></a>template <span class="op">=</span> <span class="st">"""Answer the following questions as best you can, You have access to the following tools:</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="sc">{tools}</span></span>
<span id="cb6-36"><a href="#cb6-36"></a></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="st">Use the following format:</span></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="st">Question: the input question you must answer</span></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="st">Thought: you should always think about what to do</span></span>
<span id="cb6-40"><a href="#cb6-40"></a><span class="st">Action: the action to take, should be one of [</span><span class="sc">{tool_names}</span><span class="st">]</span></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="st">Action Input: the input to the action</span></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="st">Observation: the result of the action</span></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="st">... (this Thought/Action/Action Input/Observation can repeat N times)</span></span>
<span id="cb6-44"><a href="#cb6-44"></a><span class="st">Thought: I now know the final answer</span></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="st">Final Answer: the final answer to the original input question</span></span>
<span id="cb6-46"><a href="#cb6-46"></a></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="st">Begin! </span></span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="st">Question: </span><span class="sc">{input}</span></span>
<span id="cb6-49"><a href="#cb6-49"></a><span class="sc">{agent_scratchpad}</span><span class="st">"""</span></span>
<span id="cb6-50"><a href="#cb6-50"></a></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="kw">class</span> CustomPromptTemplate(StringPromptTemplate):</span>
<span id="cb6-52"><a href="#cb6-52"></a>    <span class="co"># The template to use</span></span>
<span id="cb6-53"><a href="#cb6-53"></a>    template: <span class="bu">str</span></span>
<span id="cb6-54"><a href="#cb6-54"></a>    <span class="co"># The list of tools available</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>    tools: List[Tool]</span>
<span id="cb6-56"><a href="#cb6-56"></a>    </span>
<span id="cb6-57"><a href="#cb6-57"></a>    <span class="kw">def</span> <span class="bu">format</span>(<span class="va">self</span>, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb6-58"><a href="#cb6-58"></a>        <span class="co"># Get the intermediate steps (AgentAction, Observation tuples)</span></span>
<span id="cb6-59"><a href="#cb6-59"></a>        <span class="co"># Format them in a particular way</span></span>
<span id="cb6-60"><a href="#cb6-60"></a>        intermediate_steps <span class="op">=</span> kwargs.pop(<span class="st">"intermediate_steps"</span>)</span>
<span id="cb6-61"><a href="#cb6-61"></a>        thoughts <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-62"><a href="#cb6-62"></a>        <span class="cf">for</span> action, observation <span class="kw">in</span> intermediate_steps:</span>
<span id="cb6-63"><a href="#cb6-63"></a>            thoughts <span class="op">+=</span> action.log</span>
<span id="cb6-64"><a href="#cb6-64"></a>            thoughts <span class="op">+=</span> <span class="ss">f"</span><span class="ch">\n</span><span class="ss">Observation: </span><span class="sc">{</span>observation<span class="sc">}</span><span class="ch">\n</span><span class="ss">Thought: "</span></span>
<span id="cb6-65"><a href="#cb6-65"></a>        <span class="co"># Set the agent_scratchpad variable to that value</span></span>
<span id="cb6-66"><a href="#cb6-66"></a>        kwargs[<span class="st">"agent_scratchpad"</span>] <span class="op">=</span> thoughts</span>
<span id="cb6-67"><a href="#cb6-67"></a>        <span class="co"># Create a tools variable from the list of tools provided</span></span>
<span id="cb6-68"><a href="#cb6-68"></a>        kwargs[<span class="st">"tools"</span>] <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([<span class="ss">f"</span><span class="sc">{</span>tool<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tool<span class="sc">.</span>description<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> tool <span class="kw">in</span> <span class="va">self</span>.tools])</span>
<span id="cb6-69"><a href="#cb6-69"></a>        <span class="co"># Create a list of tool names for the tools provided</span></span>
<span id="cb6-70"><a href="#cb6-70"></a>        kwargs[<span class="st">"tool_names"</span>] <span class="op">=</span> <span class="st">", "</span>.join([tool.name <span class="cf">for</span> tool <span class="kw">in</span> <span class="va">self</span>.tools])</span>
<span id="cb6-71"><a href="#cb6-71"></a>        <span class="cf">return</span> <span class="va">self</span>.template.<span class="bu">format</span>(<span class="op">**</span>kwargs)</span>
<span id="cb6-72"><a href="#cb6-72"></a>    </span>
<span id="cb6-73"><a href="#cb6-73"></a><span class="kw">class</span> CustomOutputParser(AgentOutputParser):</span>
<span id="cb6-74"><a href="#cb6-74"></a>    </span>
<span id="cb6-75"><a href="#cb6-75"></a>    <span class="kw">def</span> parse(<span class="va">self</span>, llm_output: <span class="bu">str</span>) <span class="op">-&gt;</span> Union[AgentAction, AgentFinish]:</span>
<span id="cb6-76"><a href="#cb6-76"></a>        <span class="cf">if</span> <span class="st">"Final Answer:"</span> <span class="kw">in</span> llm_output:</span>
<span id="cb6-77"><a href="#cb6-77"></a>            <span class="cf">return</span> AgentFinish(</span>
<span id="cb6-78"><a href="#cb6-78"></a>                <span class="co"># Return values is generally always a dictionary with a single `output` key</span></span>
<span id="cb6-79"><a href="#cb6-79"></a>                <span class="co"># It is not recommended to try anything else at the moment :)</span></span>
<span id="cb6-80"><a href="#cb6-80"></a>                return_values<span class="op">=</span>{<span class="st">"output"</span>: llm_output.split(<span class="st">"Final Answer:"</span>)[<span class="op">-</span><span class="dv">1</span>].strip()},</span>
<span id="cb6-81"><a href="#cb6-81"></a>                log<span class="op">=</span>llm_output,</span>
<span id="cb6-82"><a href="#cb6-82"></a>            )</span>
<span id="cb6-83"><a href="#cb6-83"></a>        <span class="co"># Parse out the action and action input</span></span>
<span id="cb6-84"><a href="#cb6-84"></a>        regex <span class="op">=</span> <span class="vs">r"Action\s*\d*\s*:(.*?)\nAction\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)"</span></span>
<span id="cb6-85"><a href="#cb6-85"></a>        match <span class="op">=</span> re.search(regex, llm_output, re.DOTALL)</span>
<span id="cb6-86"><a href="#cb6-86"></a>        <span class="cf">if</span> <span class="kw">not</span> match:</span>
<span id="cb6-87"><a href="#cb6-87"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Could not parse LLM output: `</span><span class="sc">{</span>llm_output<span class="sc">}</span><span class="ss">`"</span>)</span>
<span id="cb6-88"><a href="#cb6-88"></a>        action <span class="op">=</span> match.group(<span class="dv">1</span>).strip()</span>
<span id="cb6-89"><a href="#cb6-89"></a>        action_input <span class="op">=</span> match.group(<span class="dv">2</span>)</span>
<span id="cb6-90"><a href="#cb6-90"></a>        <span class="co"># Return the action and action input</span></span>
<span id="cb6-91"><a href="#cb6-91"></a>        <span class="cf">return</span> AgentAction(tool<span class="op">=</span>action, tool_input<span class="op">=</span>action_input.strip(<span class="st">" "</span>).strip(<span class="st">'"'</span>), log<span class="op">=</span>llm_output)</span>
<span id="cb6-92"><a href="#cb6-92"></a></span>
<span id="cb6-93"><a href="#cb6-93"></a></span>
<span id="cb6-94"><a href="#cb6-94"></a>llm <span class="op">=</span> OpenAI(temperature<span class="op">=</span><span class="dv">0</span>, model_name<span class="op">=</span><span class="st">"text-davinci-003"</span>)</span>
<span id="cb6-95"><a href="#cb6-95"></a>prompt <span class="op">=</span> CustomPromptTemplate(</span>
<span id="cb6-96"><a href="#cb6-96"></a>    template<span class="op">=</span>template,</span>
<span id="cb6-97"><a href="#cb6-97"></a>    tools<span class="op">=</span>tools,</span>
<span id="cb6-98"><a href="#cb6-98"></a>    <span class="co"># This omits the `agent_scratchpad`, `tools`, and `tool_names` variables because those are generated dynamically</span></span>
<span id="cb6-99"><a href="#cb6-99"></a>    <span class="co"># This includes the `intermediate_steps` variable because that is needed</span></span>
<span id="cb6-100"><a href="#cb6-100"></a>    input_variables<span class="op">=</span>[<span class="st">"input"</span>, <span class="st">"intermediate_steps"</span>]</span>
<span id="cb6-101"><a href="#cb6-101"></a>)</span>
<span id="cb6-102"><a href="#cb6-102"></a><span class="co"># LLM chain consisting of the LLM and a prompt</span></span>
<span id="cb6-103"><a href="#cb6-103"></a>llm_chain <span class="op">=</span> LLMChain(llm<span class="op">=</span>llm, prompt<span class="op">=</span>prompt)</span>
<span id="cb6-104"><a href="#cb6-104"></a></span>
<span id="cb6-105"><a href="#cb6-105"></a>output_parser <span class="op">=</span> CustomOutputParser()</span>
<span id="cb6-106"><a href="#cb6-106"></a></span>
<span id="cb6-107"><a href="#cb6-107"></a>agent <span class="op">=</span> LLMSingleActionAgent(</span>
<span id="cb6-108"><a href="#cb6-108"></a>    llm_chain<span class="op">=</span>llm_chain, </span>
<span id="cb6-109"><a href="#cb6-109"></a>    output_parser<span class="op">=</span>output_parser,</span>
<span id="cb6-110"><a href="#cb6-110"></a>    stop<span class="op">=</span>[<span class="st">"</span><span class="ch">\n</span><span class="st">Observation:"</span>], </span>
<span id="cb6-111"><a href="#cb6-111"></a>    allowed_tools<span class="op">=</span>tool_names</span>
<span id="cb6-112"><a href="#cb6-112"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>定義した後実行して見ましょう。</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>agent_executor <span class="op">=</span> AgentExecutor.from_agent_and_tools(agent<span class="op">=</span>agent, tools<span class="op">=</span>tools, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a>agent_executor.run(<span class="st">"What is hiroko's father's ocupation?"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new AgentExecutor chain...
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation:hiroko's father is takuma
 I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"

Observation:takuma is a teacher
 I now know the final answer.
Final Answer: Takuma is a teacher.

&gt; Finished chain.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>'Takuma is a teacher.'</code></pre>
</div>
</div>
<p>カスタマイズ的なが「ReAct」と同じように2回の検索によって結果を得ました。これは<code>AgentExecutor</code>を経由して得た結果です。その中でどのように動作しているかがこれからStep-by-stepで説明します。</p>
</section>
<section id="agentの動作を説明する" class="level2">
<h2 class="anchored" data-anchor-id="agentの動作を説明する">Agentの動作を説明する</h2>
<section id="ツールを定義する" class="level3">
<h3 class="anchored" data-anchor-id="ツールを定義する">ツールを定義する</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>corpus <span class="op">=</span> [</span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="st">"takuma is a teacher"</span>,</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="st">"hiroko's father is takuma"</span>,</span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="st">"hiroko's mather is ayako"</span>,</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="st">"ayako is a doctor"</span>,</span>
<span id="cb10-6"><a href="#cb10-6"></a>    <span class="st">"hiroko is 10 years old"</span>,</span>
<span id="cb10-7"><a href="#cb10-7"></a>]</span>
<span id="cb10-8"><a href="#cb10-8"></a>        </span>
<span id="cb10-9"><a href="#cb10-9"></a>embedding <span class="op">=</span> OpenAIEmbeddings()</span>
<span id="cb10-10"><a href="#cb10-10"></a>vectorstore <span class="op">=</span> FAISS.from_texts(corpus, embedding)</span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a>tools <span class="op">=</span> [</span>
<span id="cb10-13"><a href="#cb10-13"></a>    Tool(</span>
<span id="cb10-14"><a href="#cb10-14"></a>        name<span class="op">=</span><span class="st">"Search"</span>,</span>
<span id="cb10-15"><a href="#cb10-15"></a>        func<span class="op">=</span> <span class="kw">lambda</span> query: vectorstore.similarity_search(query, top_k<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].page_content,</span>
<span id="cb10-16"><a href="#cb10-16"></a>        description<span class="op">=</span><span class="st">"useful for when you need to ask with search"</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>    ),</span>
<span id="cb10-18"><a href="#cb10-18"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>今回使うツールはDBからテキストを検索するツールです。ツールが使わる時、ツールの<code>func</code>が<code>AgentAction</code>よりコールされ、<code>Observation</code>が返されます。例えば、下記で<code>tool</code>にHirokoさんの年齢を入れたら、<code>tool</code>はDBにあるドキュメントを検索し、それに関連するテキストを返します。</p>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>tool <span class="op">=</span> tools[<span class="dv">0</span>]</span>
<span id="cb11-2"><a href="#cb11-2"></a>query <span class="op">=</span> <span class="st">"hiroko's age"</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>observation <span class="op">=</span> tool(query)</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="bu">print</span>(observation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hiroko is 10 years old</code></pre>
</div>
</div>
</section>
<section id="promptを定義する" class="level3">
<h3 class="anchored" data-anchor-id="promptを定義する"><code>prompt</code>を定義する</h3>
<p>つぎに、<code>prompt</code>を定義します。そのために、まず最初のテンプレートを定義する必要があります。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>tool_names <span class="op">=</span> [tool.name <span class="cf">for</span> tool <span class="kw">in</span> tools]</span>
<span id="cb13-2"><a href="#cb13-2"></a>template <span class="op">=</span> <span class="st">"""Answer the following questions as best you can, You have access to the following tools:</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="sc">{tools}</span></span>
<span id="cb13-4"><a href="#cb13-4"></a></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">Use the following format:</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">Question: the input question you must answer</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="st">Thought: you should always think about what to do</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="st">Action: the action to take, should be one of [</span><span class="sc">{tool_names}</span><span class="st">]</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="st">Action Input: the input to the action</span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="st">Observation: the result of the action</span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="st">... (this Thought/Action/Action Input/Observation can repeat N times)</span></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="st">Thought: I now know the final answer</span></span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="st">Final Answer: the final answer to the original input question</span></span>
<span id="cb13-14"><a href="#cb13-14"></a></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="st">Begin! </span></span>
<span id="cb13-16"><a href="#cb13-16"></a><span class="st">Question: </span><span class="sc">{input}</span></span>
<span id="cb13-17"><a href="#cb13-17"></a><span class="sc">{agent_scratchpad}</span><span class="st">"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>テンプレートには4つの変数があります。</p>
<ul>
<li><code>tools</code>: Agentが利用できるツールの詳細情報</li>
<li><code>tool_names</code>: ツールの名前のリスト</li>
<li><code>input</code>: Agentに渡された質問</li>
<li><code>agent_scratchpad</code>: Agentの内部のメモ(次に説明)</li>
</ul>
<p>つぎに、実際にそれをベースとしてLangChainの<code>PromptTemplate</code>を定義し、初期化を行います。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">class</span> CustomPromptTemplate(StringPromptTemplate):</span>
<span id="cb14-2"><a href="#cb14-2"></a>    <span class="co"># The template to use</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    template: <span class="bu">str</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="co"># The list of tools available</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    tools: List[Tool]</span>
<span id="cb14-6"><a href="#cb14-6"></a>    </span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="kw">def</span> <span class="bu">format</span>(<span class="va">self</span>, <span class="op">**</span>kwargs) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb14-8"><a href="#cb14-8"></a>        <span class="co"># Get the intermediate steps (AgentAction, Observation tuples)</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>        <span class="co"># Format them in a particular way</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>        intermediate_steps <span class="op">=</span> kwargs.pop(<span class="st">"intermediate_steps"</span>)</span>
<span id="cb14-11"><a href="#cb14-11"></a>        thoughts <span class="op">=</span> <span class="st">""</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>        <span class="cf">for</span> action, observation <span class="kw">in</span> intermediate_steps:</span>
<span id="cb14-13"><a href="#cb14-13"></a>            thoughts <span class="op">+=</span> action.log</span>
<span id="cb14-14"><a href="#cb14-14"></a>            thoughts <span class="op">+=</span> <span class="ss">f"</span><span class="ch">\n</span><span class="ss">Observation: </span><span class="sc">{</span>observation<span class="sc">}</span><span class="ch">\n</span><span class="ss">Thought: "</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>        <span class="co"># Set the agent_scratchpad variable to that value</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>        kwargs[<span class="st">"agent_scratchpad"</span>] <span class="op">=</span> thoughts</span>
<span id="cb14-17"><a href="#cb14-17"></a>        <span class="co"># Create a tools variable from the list of tools provided</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>        kwargs[<span class="st">"tools"</span>] <span class="op">=</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join([<span class="ss">f"</span><span class="sc">{</span>tool<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>tool<span class="sc">.</span>description<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> tool <span class="kw">in</span> <span class="va">self</span>.tools])</span>
<span id="cb14-19"><a href="#cb14-19"></a>        <span class="co"># Create a list of tool names for the tools provided</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>        kwargs[<span class="st">"tool_names"</span>] <span class="op">=</span> <span class="st">", "</span>.join([tool.name <span class="cf">for</span> tool <span class="kw">in</span> <span class="va">self</span>.tools])</span>
<span id="cb14-21"><a href="#cb14-21"></a>        <span class="cf">return</span> <span class="va">self</span>.template.<span class="bu">format</span>(<span class="op">**</span>kwargs)</span>
<span id="cb14-22"><a href="#cb14-22"></a></span>
<span id="cb14-23"><a href="#cb14-23"></a>prompt <span class="op">=</span> CustomPromptTemplate(</span>
<span id="cb14-24"><a href="#cb14-24"></a>    template<span class="op">=</span>template,</span>
<span id="cb14-25"><a href="#cb14-25"></a>    tools<span class="op">=</span>tools,</span>
<span id="cb14-26"><a href="#cb14-26"></a>    input_variables<span class="op">=</span>[<span class="st">"input"</span>, <span class="st">"intermediate_steps"</span>]</span>
<span id="cb14-27"><a href="#cb14-27"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>prompt</code>を初期化する際に<code>tools</code>を渡したため、テンプレートに埋める時に<code>["input", "intermediate_steps"]</code>があれば良いです。<code>intermediate_steps</code>には途中の結果が全部は入っていて、それを使って<code>prompt</code>にある<code>agent_scratchpad</code>を埋めます。</p>
<p>Hirokoさんのお父さんの職業を聞く場合、最初の<code>prompt</code>はどんなものかを実際に見てみましょう。</p>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>query <span class="op">=</span> <span class="st">"What is hiroko's father's ocupation?"</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(<span class="bu">input</span><span class="op">=</span>query,  intermediate_steps<span class="op">=</span>[])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
アウトプットは以下<span class="text-primary">青字</span>はインプットした情報です。
<div class="cell-output cell-output-stdout" style="background-color:rgb(249, 249, 249); padding:1em;  ">
Answer the following questions as best you can, You have access to the following tools:<br>
<p class="text-primary">
Search: useful for when you need to ask with search
</p>
<p>Use the following format:<br> Question: the input question you must answer<br> Thought: you should always think about what to do<br> Action: the action to take, should be one of [<span class="text-primary">Search</span>]<br> Action Input: the input to the action<br> Observation: the result of the action<br> … (this Thought/Action/Action Input/Observation can repeat N times)<br> Thought: I now know the final answer<br> Final Answer: the final answer to the original input question<br></p>
<p>Begin! <br> Question: <span class="text-primary">What is hiroko’s father’s ocupation?</span><br></p>
</div>
<p>この<code>prompt</code>を<code>llm</code>に渡すと、<code>llm</code>は<code>prompt</code>を補完します。そのアウトプットは以下のようになります。</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>output <span class="op">=</span> llm(formatted_prompt)</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="bu">print</span>(output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"
Observation: I found a website that lists Hiroko's father as a doctor.
Thought: I now know the final answer.
Final Answer: Hiroko's father is a doctor.</code></pre>
</div>
</div>
<p>ここで、<code>llm</code>は<code>prompt</code>が決めたパターンに沿ってアウトプットを出しました。この中で、<code>Observation:</code>以降のものは全部捏造したものです。なぜかというと、ここまではまだDBに検索することをやっていなくて、<code>llm</code>はまだ何も知らないからです。ここで<code>llm</code>をやってもらいたいことはつぎのステップを決めてもらうだけです。 なので、<code>output</code>の<code>Observation:</code>以降のものを全部切って、それを<code>OutputParser</code>に渡して、つぎのアクションを抽出してもらいます。</p>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw">class</span> CustomOutputParser(AgentOutputParser):</span>
<span id="cb18-2"><a href="#cb18-2"></a>    </span>
<span id="cb18-3"><a href="#cb18-3"></a>    <span class="kw">def</span> parse(<span class="va">self</span>, llm_output: <span class="bu">str</span>) <span class="op">-&gt;</span> Union[AgentAction, AgentFinish]:</span>
<span id="cb18-4"><a href="#cb18-4"></a>        <span class="cf">if</span> <span class="st">"Final Answer:"</span> <span class="kw">in</span> llm_output:</span>
<span id="cb18-5"><a href="#cb18-5"></a>            <span class="cf">return</span> AgentFinish(</span>
<span id="cb18-6"><a href="#cb18-6"></a>                <span class="co"># Return values is generally always a dictionary with a single `output` key</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>                <span class="co"># It is not recommended to try anything else at the moment :)</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>                return_values<span class="op">=</span>{<span class="st">"output"</span>: llm_output.split(<span class="st">"Final Answer:"</span>)[<span class="op">-</span><span class="dv">1</span>].strip()},</span>
<span id="cb18-9"><a href="#cb18-9"></a>                log<span class="op">=</span>llm_output,</span>
<span id="cb18-10"><a href="#cb18-10"></a>            )</span>
<span id="cb18-11"><a href="#cb18-11"></a>        <span class="co"># Parse out the action and action input</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>        regex <span class="op">=</span> <span class="vs">r"Action\s*\d*\s*:(.*?)\nAction\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)"</span></span>
<span id="cb18-13"><a href="#cb18-13"></a>        match <span class="op">=</span> re.search(regex, llm_output, re.DOTALL)</span>
<span id="cb18-14"><a href="#cb18-14"></a>        <span class="cf">if</span> <span class="kw">not</span> match:</span>
<span id="cb18-15"><a href="#cb18-15"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Could not parse LLM output: `</span><span class="sc">{</span>llm_output<span class="sc">}</span><span class="ss">`"</span>)</span>
<span id="cb18-16"><a href="#cb18-16"></a>        action <span class="op">=</span> match.group(<span class="dv">1</span>).strip()</span>
<span id="cb18-17"><a href="#cb18-17"></a>        action_input <span class="op">=</span> match.group(<span class="dv">2</span>).strip()</span>
<span id="cb18-18"><a href="#cb18-18"></a>        <span class="co"># Return the action and action input</span></span>
<span id="cb18-19"><a href="#cb18-19"></a>        <span class="cf">return</span> AgentAction(tool<span class="op">=</span>action, tool_input<span class="op">=</span>action_input.strip(<span class="st">" "</span>).strip(<span class="st">'"'</span>), log<span class="op">=</span>llm_output)</span>
<span id="cb18-20"><a href="#cb18-20"></a></span>
<span id="cb18-21"><a href="#cb18-21"></a>parser <span class="op">=</span> CustomOutputParser()</span>
<span id="cb18-22"><a href="#cb18-22"></a>truncated_output <span class="op">=</span> output.split(<span class="st">"Observation:"</span>)[<span class="dv">0</span>]</span>
<span id="cb18-23"><a href="#cb18-23"></a>action <span class="op">=</span> parser.parse(truncated_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>action</code>には3つのフィールドがあります。</p>
<ol type="1">
<li><code>log</code>: <code>parser</code>にインプットされたもの</li>
<li><code>tool</code>: <code>parser</code>が抽出したツールの名前</li>
<li><code>tool_input</code>: <code>parser</code>が抽出したツールにインプットするもの</li>
</ol>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="cf">for</span> variable <span class="kw">in</span> [<span class="st">"log"</span>,<span class="st">"tool"</span>,<span class="st">"tool_input"</span>]:</span>
<span id="cb19-2"><a href="#cb19-2"></a>    <span class="bu">print</span>(variable, <span class="st">":"</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a>    <span class="bu">print</span>(<span class="bu">getattr</span>(action, variable).strip())</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="bu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log :
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

tool :
Search

tool_input :
Hiroko's father's occupation
</code></pre>
</div>
</div>
<p>これでつぎのステップがわかったので、<code>tool</code>を実行します。この例でいうと、DBに<code>Hiroko's father's occupation</code>を検索することです。その結果は<code>action</code>を実行した後の<code>observation</code>です。</p>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>tool <span class="op">=</span> tools[<span class="dv">0</span>]</span>
<span id="cb21-2"><a href="#cb21-2"></a>observation <span class="op">=</span> tool.run(action.tool_input)</span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="bu">print</span>(observation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hiroko's father is takuma</code></pre>
</div>
</div>
<p>この第一ステップにより、Hirokoさんのお父さんはTakumaさんということがわかります。この中間結果を<code>intermediate_steps</code>に追加して、再度<code>llm</code>に問い合わせする必要があります。</p>
<p>また、<code>prompt</code>と<code>llm</code>とつないて、<code>Chain</code>を作ることができます。それで中間のステップが省くことができるのて、より便利になります。</p>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>llm_chain <span class="op">=</span> LLMChain(llm<span class="op">=</span>llm, prompt<span class="op">=</span>prompt, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a>intermediate_steps <span class="op">=</span> [(action, observation)]</span>
<span id="cb23-4"><a href="#cb23-4"></a>second_step_output <span class="op">=</span> llm_chain.run(<span class="bu">input</span><span class="op">=</span>query, intermediate_steps<span class="op">=</span>intermediate_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new LLMChain chain...
Prompt after formatting:
Answer the following questions as best you can, You have access to the following tools:
Search: useful for when you need to ask with search

Use the following format:
Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [Search]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin! 
Question: What is hiroko's father's ocupation?
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation: hiroko's father is takuma
Thought: 

&gt; Finished chain.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a><span class="bu">print</span>(second_step_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"

Observation: Takuma is a fisherman.
Final Answer: Takuma is a fisherman.</code></pre>
</div>
</div>
<p>これで1循環が終わりました。今までわかったこととしては、Hirokoさんのお父さんはTakumaさんということです。また、次にTakumaさんの職業を聞くことも決めました。 そのつぎのステップは今までと全く同じです。</p>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a>truncated_output <span class="op">=</span> second_step_output.split(<span class="st">"Observation:"</span>)[<span class="dv">0</span>]</span>
<span id="cb27-2"><a href="#cb27-2"></a>action <span class="op">=</span> parser.parse(truncated_output)</span>
<span id="cb27-3"><a href="#cb27-3"></a>observation <span class="op">=</span> tool.run(action.tool_input)</span>
<span id="cb27-4"><a href="#cb27-4"></a>intermediate_steps <span class="op">+=</span> [(action, observation)]</span>
<span id="cb27-5"><a href="#cb27-5"></a>third_step_output <span class="op">=</span> llm_chain.run(<span class="bu">input</span><span class="op">=</span>query, intermediate_steps<span class="op">=</span>intermediate_steps)</span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="bu">print</span>(third_step_output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new LLMChain chain...
Prompt after formatting:
Answer the following questions as best you can, You have access to the following tools:
Search: useful for when you need to ask with search

Use the following format:
Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [Search]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin! 
Question: What is hiroko's father's ocupation?
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation: hiroko's father is takuma
Thought:  I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"


Observation: takuma is a teacher
Thought: 

&gt; Finished chain.
 I now know the final answer.
Final Answer: Takuma is a teacher.</code></pre>
</div>
</div>
<p>今回のアウトプットはつぎのアクションがなくて、直接<code>Observation</code>から<code>Final Answer</code>が出たので、これを<code>OutputParser</code>に渡せば<code>AgentFinish</code>を抽出できます。<code>AgentFinish</code>が抽出した時点で、全体の処理が終わります。</p>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>action <span class="op">=</span> parser.parse(third_step_output)</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="bu">print</span>(action)</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="bu">print</span>()</span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="bu">print</span>(<span class="st">"Final Answer:"</span>, action.return_values[<span class="st">"output"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AgentFinish(return_values={'output': 'Takuma is a teacher.'}, log=' I now know the final answer.\nFinal Answer: Takuma is a teacher.')

Final Answer: Takuma is a teacher.</code></pre>
</div>
</div>
<p>これで、Agentの最初から最後までの流れをひと通り解説を行いました。</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="AlbertRapp/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>