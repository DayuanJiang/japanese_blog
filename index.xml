<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>blog</title>
<link>https://jiang.jp/index.html</link>
<atom:link href="https://jiang.jp/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.3.340</generator>
<lastBuildDate>Tue, 09 May 2023 15:00:00 GMT</lastBuildDate>
<item>
  <title>Azure OpenAI Serviceの利用について</title>
  <link>https://jiang.jp/posts/20230513_azure_openai/index.html</link>
  <description><![CDATA[ 



<p>最近、GPTを用いた提案を行う際のマナーについていくつかの問い合わせを受けています。実は、筆者もGPTを利用したプロジェクトを担当し、いくつかの問題でコケた経験があります。その経験をまとめてみたいと思います。</p>
<section id="azure-openai-serviceを使う必要がある" class="level2">
<h2 class="anchored" data-anchor-id="azure-openai-serviceを使う必要がある">Azure OpenAI Serviceを使う必要がある</h2>
<p><a href="https://azure.microsoft.com/ja-jp/products/cognitive-services/openai-service">Azure OpenAI Service</a> は、マイクロソフトがOpenAIを買収した後、Azureを基盤として提供しているOpenAIのAPIサービスです。Azure OpenAI Serviceは、OpenAI APIとAzureエンタープライズレベルのセキュリティ、コンプライアンス、リージョンの可用性を組み合わせています。</p>
<p><strong>つまり、Azure OpenAI Serviceを使うことで、セキュリティー等の面倒なものを全部Azureに委ね、こちらはOpenAIのAPIの利用に専念することができます。</strong></p>
<p>Azure OpenAI Serviceを使うために、いくつかの事前準備が必要です。</p>
<p>その流れは以下です。階層構造は先決条件を意味しています。</p>
<pre><code>→Azureアカウント申請(即日)
    → Azure OpenAI Service申請 (1〜2日)
        → Opt-out申請 (2〜4日)
        → GPT4申請(？日 後日補足)</code></pre>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
許可時間
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>()</code>の中にあるのは時間の目安です。あくまでも目安なので、そうはならない可能性も十分あることをご理解ください。</p>
</div>
</div>
<p>各申請フォームは以下です。</p>
<ul>
<li><p><a href="https://customervoice.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7en2Ais5pxKtso_Pz4b1_xUOFA5Qk1UWDRBMjg0WFhPMkIzTzhKQ1dWNyQlQCN0PWcu">Azure OpenAI Service申請フォーム</a></p></li>
<li><p><a href="https://customervoice.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7en2Ais5pxKtso_Pz4b1_xURE01NDY1OUhBRzQ3MkQxMUhZSE1ZUlJKTiQlQCN0PW">Opt-out申請フォーム</a></p></li>
<li><p><a href="https://customervoice.microsoft.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR7en2Ais5pxKtso_Pz4b1_xURjE4QlhVUERGQ1NXOTlNT0w1NldTWjJCMSQlQCN0PWcu">GPT4申請フォーム</a></p></li>
</ul>
</section>
<section id="opt-outとは" class="level2">
<h2 class="anchored" data-anchor-id="opt-outとは">Opt-outとは</h2>
<p>一般的に、下図のように、GPTモデルへのすべての入力と出力はAzure側で30日間保存されます。これは、Azureが倫理違反等の不適切な行為の有無を審査するための措置です。そのデータの保存を禁止することはOpt-out申請の目的です。 詳細は<a href="https://learn.microsoft.com/en-us/legal/cognitive-services/openai/data-privacy#can-a-customer-opt-out-of-the-logging-and-human-review-process">ここ</a>で確認できます。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230513_azure_openai/images/paste-1.png" class="img-fluid figure-img" alt="data flow" width="1000"></p>
<figcaption class="figure-caption">data flow</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>このデータの保存はあくまでも審査目的なので、Azure OpenAI Serviceは顧客データを一切モデルの学習等に利用しない約束を<a href="https://learn.microsoft.com/en-us/legal/cognitive-services/openai/data-privacy#is-customer-data-used-to-train-the-openai-models">ホームページ</a>で明記しています。</p>
</div>
</div>
</section>
<section id="個人情報を扱う場合" class="level2">
<h2 class="anchored" data-anchor-id="個人情報を扱う場合">個人情報を扱う場合</h2>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>(筆者も法律のことは詳しくないので、以下の話は経験に過ぎなくて、もっと良いやり方があるかもしれません。)</p>
</div>
</div>
<p>Azure OpenAI Service申請する際に、リージョンを選ぶ必要があります。個人情報を含むデータを処理する場合はWest Europeを選択したほうが無難です。</p>
<p>なぜかどいうと、EUのGDPRは日本の個人情報保護法と互換性があるため、契約上の法務上の手続きがしやすいためです。国の機関である個人情報保護委員会は<a href="https://www.ppc.go.jp/enforcement/cooperation/cooperation/sougoninshou/index.html">『日EU間・日英間のデータ越境移転について』</a>で、日EU間のデータ越境移転について以下のように述べています。</p>
<blockquote class="blockquote">
<p>日EU間では、相互の円滑な個人データの移転を図る相互認証の枠組みが成立しており、互いのデータ保護制度を同等とみなし、両者間での自由な個人データ流通が可能となっています。</p>
</blockquote>
<p>しかし、West Europeをリージョンとして選択することにはデメリットもあります。それは最新のモデルがすぐに利用できないことです。例えば、現時点ではGPT4はまだWest Europeで利用できません。これから新しいモデルが出ても、それがWest Europeで適用されるまでに時間がかかる可能性があります。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Azureの担当者にリージョン問題について問い合わせたところ、「どのリージョンでデプロイしても、Azure OpenAI ServiceはGDPRに準拠しています」との回答を得ました。 <a href="https://learn.microsoft.com/en-us/answers/questions/1254112/has-microsoft-concluded-azure-open-ai-with-gdpr">このページ</a>で同じ回答を確認することができます。したがって、リージョンをアメリカに設定することも可能かもしれません。ただし、アメリカを選ぶ場合には、さらなる調査が必要です。</p>
</div>
</div>


</section>

 ]]></description>
  <category>NLP</category>
  <category>LLMs</category>
  <category>LangChain</category>
  <guid>https://jiang.jp/posts/20230513_azure_openai/index.html</guid>
  <pubDate>Tue, 09 May 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>LangChain Agentの全面解説</title>
  <link>https://jiang.jp/posts/20230509_react/index.html</link>
  <description><![CDATA[ 



<p>LangChainの中に最もハイレベルな概念としてはAgentです。以前の投稿の中でも話ましたが、LangChainはまだ未熟なライブラリなので、Agentの実装は複雑なものになっていますし、中身の挙動を説明するドキュメントもなかったので、本文ではAgentの使い方から、インプットからアウトプットまでの流れを説明していきます。</p>
<section id="reactを例にlangchainのagentを紹介する" class="level2">
<h2 class="anchored" data-anchor-id="reactを例にlangchainのagentを紹介する">ReActを例にLangChainのAgentを紹介する</h2>
<p>LangChainのAgentとは、簡単に言うとツールを利用できるLLMです。</p>
<p>典型の例としては「ReAct」が挙げられます。去年出されている「ReAct: Synergizing Reasoning and Acting in Language Models」の論文の中で、思考だけではなく、思考に基づいて行動を起こし、さらに行動の結果から思考を行うLLMsの利用方法を提案した。そのやり方はReasoningとActingの結合なので、「ReAct」と名付けられました。</p>
<p>実際の例で見ましょう。下記のコードはLangChainで定義したReActのAgentです。このAgentは検索と照応の2つのツールを持っています。人間と同じように、質問が投げられた後、Wikipediaで検査し、検索した結果からコピペー(照応)しながら答案を作ることができます。</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI, Wikipedia</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> initialize_agent, Tool</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentType</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents.react.base <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DocstoreExplorer</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the environment variables</span></span>
<span id="cb1-7">load_dotenv()</span>
<span id="cb1-8"></span>
<span id="cb1-9">docstore<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>DocstoreExplorer(Wikipedia())</span>
<span id="cb1-10">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb1-11">    Tool(</span>
<span id="cb1-12">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search"</span>,</span>
<span id="cb1-13">        func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>docstore.search,</span>
<span id="cb1-14">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"useful for when you need to ask with search"</span></span>
<span id="cb1-15">    ),</span>
<span id="cb1-16">    Tool(</span>
<span id="cb1-17">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lookup"</span>,</span>
<span id="cb1-18">        func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>docstore.lookup,</span>
<span id="cb1-19">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"useful for when you need to ask with lookup"</span></span>
<span id="cb1-20">    )</span>
<span id="cb1-21">]</span>
<span id="cb1-22"></span>
<span id="cb1-23">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-davinci-003"</span>)</span>
<span id="cb1-24">react <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> initialize_agent(tools, llm, agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>AgentType.REACT_DOCSTORE, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</div>
<p>クリントンの奥さんが何をしているかを聞いてみましょう。</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1">react.run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What do Bill Clinton's wife do for a living?"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new AgentExecutor chain...
Thought: I need to search Bill Clinton and find his wife, then find what she does for a living.
Action: Search[Bill Clinton]
Observation: William Jefferson Clinton (né Blythe III; born August 19, 1946) is an American politician  who served as the 42nd president of the United States from 1993 to 2001. He previously served as governor of Arkansas from 1979 to 1981 and again from 1983 to 1992, and as attorney general of Arkansas from 1977 to 1979. A member of the Democratic Party, Clinton became known as a New Democrat, as many of his policies reflected a centrist "Third Way" political philosophy. He is the husband of Hillary Clinton, who was a U.S. senator from New York from 2001 to 2009, secretary of state from 2009 to 2013 and the Democratic nominee for president in the 2016 presidential election.
Clinton was born and raised in Arkansas and attended Georgetown University. He received a Rhodes Scholarship to study at University College, Oxford, and later graduated from Yale Law School. He met Hillary Rodham at Yale; they married in 1975. After graduating from law school, Clinton returned to Arkansas and won election as state attorney general, followed by two non-consecutive tenures as Arkansas governor. As governor, he overhauled the state's education system and served as chairman of the National Governors Association. Clinton was elected president in the 1992 presidential election, defeating incumbent Republican president George H. W. Bush and independent businessman Ross Perot. At 46 years old, he became the third-youngest president of the United States and the first president to be born in the Baby Boomer generation.
Clinton presided over the longest period of peacetime economic expansion in American history. He signed into law the North American Free Trade Agreement (NAFTA) and the Violent Crime Control and Law Enforcement Act, but failed to pass his plan for national health care reform. The Republican Party won unified control of Congress for the first time in 40 years in the 1994 elections, but Clinton was still comfortably re-elected in 1996, becoming the first Democrat since Franklin D. Roosevelt to win a second full term. Starting in the mid-1990s, he began an ideological evolution as he became much more conservative in his domestic policy, advocating for and signing the Personal Responsibility and Work Opportunity Act, the State Children's Health Insurance Program and financial deregulation measures. He appointed Ruth Bader Ginsburg and Stephen Breyer to the U.S. Supreme Court. During the last three years of Clinton's presidency, the Congressional Budget Office reported a budget surplus—the first such surplus since 1969. In foreign policy, Clinton ordered U.S. military intervention in the Bosnian and Kosovo wars, eventually signing the Dayton Peace agreement. He also called for the expansion of NATO in Eastern Europe and many former Warsaw Pact members joined NATO during his presidency. Clinton's foreign policy in the Middle East saw him sign the Iraq Liberation Act which gave aid to groups against Saddam Hussein. He also participated in the Oslo I Accord and Camp David Summit to advance the Israeli–Palestinian peace process, and assisted the Northern Ireland peace process.
Clinton's second term was dominated by the Monica Lewinsky scandal, which began in 1996, when he had a sexual relationship with 22-year-old Monica Lewinsky, an intern at the White House. In January 1998, news of the affair made tabloid headlines. This scandal escalated throughout the year, culminating on December 19 when Clinton was impeached by the House of Representatives, becoming the second U.S. president—the first since Andrew Johnson—to be impeached. The two impeachment articles that the House passed were centered around him using the powers of the presidency to obstruct the investigation and lying under oath. In 1999, Clinton's impeachment trial began in the Senate. He was acquitted on both charges as the Senate failed to cast 67 votes against him, which was necessary to meet the two-thirds conviction threshold prescribed by Article I, section 3, clause 6 of the U.S. Constitution.
Clinton left office in 2001 with the joint-highest approval rating of any U.S. president in the modern era, alongside Franklin D. Roosevelt and Ronald Reagan. His presidency has been ranked among the upper tier in historical rankings of U.S. presidents. However, his personal conduct and allegations of sexual assault have made him the subject of substantial scrutiny. Since leaving office, Clinton has been involved in public speaking and humanitarian work. He created the Clinton Foundation to address international causes such as the prevention of HIV/AIDS and global warming. In 2009, he was named the United Nations Special Envoy to Haiti. After the 2010 Haiti earthquake, Clinton and George W. Bush formed the Clinton Bush Haiti Fund. He has remained active in Democratic Party politics, campaigning for his wife's 2008 and 2016 presidential campaigns.
Thought: Bill Clinton's wife is Hillary Clinton. I need to search Hillary Clinton and find what she does for a living.
Action: Search[Hillary Clinton]
Observation: Hillary Diane Rodham Clinton (born October 26, 1947) is an American politician and diplomat who served as the 67th United States secretary of state under president Barack Obama from 2009 to 2013, as a United States senator representing New York from 2001 to 2009, and as the first lady of the United States as the wife of President Bill Clinton from 1993 to 2001. A member of the Democratic Party, she was the party's nominee for president in the 2016 presidential election, becoming the first woman to win a presidential nomination by a major U.S. political party. Clinton won the popular vote, but lost the Electoral College vote, thereby losing the election to Donald Trump.
Raised in the Chicago suburb of Park Ridge, Rodham graduated from Wellesley College in 1969 and earned a Juris Doctor degree from Yale Law School in 1973. After serving as a congressional legal counsel, she moved to Arkansas and married future president Bill Clinton in 1975; the two had met at Yale. In 1977, Clinton co-founded Arkansas Advocates for Children and Families. She was appointed the first female chair of the Legal Services Corporation in 1978 and became the first female partner at Little Rock's Rose Law Firm the following year. The National Law Journal twice listed her as one of the hundred most influential lawyers in America. Clinton was the  First Lady of Arkansas from 1979 to 1981 and again from 1983 to 1992. As the first lady of the United States, Clinton advocated for healthcare reform. In 1994, her major initiative—the Clinton health care plan—failed to gain approval from Congress. In 1997 and 1999, Clinton played a leading role in advocating the creation of the State Children's Health Insurance Program, the Adoption and Safe Families Act, and the Foster Care Independence Act. Clinton advocated for gender equality at the 1995 UN conference on women. Her marital relationship came under public scrutiny during the Lewinsky scandal, which led her to issue a statement that reaffirmed her commitment to the marriage.
In 2000, Clinton was elected as the first female senator from New York and became the first First lady to simultaneously hold elected office, and then the first former First lady to serve in the Senate. She was re-elected in 2006 and chaired the Senate Democratic Steering and Outreach Committee from 2003 to 2007. During her Senate tenure, Clinton advocated for medical benefits for September 11 first responders. She supported the resolution authorizing the Iraq War in 2002, but opposed the surge of U.S. troops in 2007. In 2008, Clinton ran for president but was defeated by eventual winner Barack Obama in the Democratic primaries. Clinton was U.S. Secretary of State in the first term of the Obama administration from 2009 to 2013. During her tenure, Clinton established the Quadrennial Diplomacy and Development Review. She responded to the Arab Spring by advocating military intervention in Libya but was harshly criticized by Republicans for the failure to prevent or adequately respond to the 2012 Benghazi attack. Clinton helped to organize a diplomatic isolation and a regime of international sanctions against Iran in an effort to force it to curtail its nuclear program; this effort eventually led to the multinational JCPOA nuclear agreement in 2015. Her use of a private email server when she was Secretary of State was the subject of intense scrutiny; while no charges were filed against Clinton, the email controversy was the single most covered topic during the 2016 presidential election.
Clinton made a second presidential run in 2016, winning the Democratic nomination, and ran in the general election with Virginia senator Tim Kaine as her running mate. Clinton lost the presidential election to Republican opponent Donald Trump in the Electoral College, despite winning the popular vote by close to 3 million votes. Following her loss, she wrote her third memoir, What Happened, and launched Onward Together, a political action organization dedicated to fundraising for progressive political groups. Since February 2023, she has served on the faculty of the School of International and Public Affairs at Columbia University.
Thought: Hillary Clinton is a politician, diplomat, and lawyer. So the answer is politician, diplomat, and lawyer.
Action: Finish[politician, diplomat, lawyer]

&gt; Finished chain.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>'politician, diplomat, lawyer'</code></pre>
</div>
</div>
<p>ご覧の通り、Agentが質問を受けた後、まず「先にクリントンの奥さんの名前を調べて、それから彼女の仕事を調べる」というプランを立てました。そして、そのプランに基づいて、Wikipediaでまずクリントンを検索し、その結果からヒラリーを特定し、さらにヒラリーの仕事を調べて、答案を作りました。</p>
<p>これで、LangChainのAgentの基本がわかりました。しかし、上記のことはLangChainが実装されているReActをCALLして利用しているだけです。自分でカスタマイズのAgentを作るにはどうすればよいかを、これから説明します。</p>
</section>
<section id="カスタマイズのagentを作る" class="level2">
<h2 class="anchored" data-anchor-id="カスタマイズのagentを作る">カスタマイズのAgentを作る</h2>
<p>Agentは3つの要素から構成されています。</p>
<ul>
<li><code>PromptTemplate</code>: Agentの中の一番コアな部分です。このテンプレートでAgentの挙動を定義します。</li>
<li><code>llm</code>: Agentが利用するLLMです。</li>
<li><code>OutptParser</code>: LLMのアウトプットを解析し、AgentActionもしくはAgentFinishを生成するモジュールです。</li>
</ul>
<p>作られたAgentは<code>AgentExecutor</code>を通じで、以下のステップで実行します。</p>
<ol type="1">
<li>ユーザー入力とそれまでのステップをエージェントに渡す。</li>
<li>エージェントが<code>AgentFinish</code>を返す場合、それを直接結果に返す。</li>
<li>Agentが<code>AgentAction</code>を返した場合、それを使ってツールを呼び出し、Observationを取得します。</li>
<li><code>AgentFinish</code>が返されるまで、<code>AgentAction</code>と<code>Observation</code>をAgentに戻すことを繰り返します。</li>
</ol>
<p>これから実際にカスタマイズ的なAgentを作りましょう。</p>
<p>このAgentは「Search」のツールでDBから情報を取得し、質問に答えることができます。 DBの中で「Hiroko」さんの家族に関する情報が入っています。</p>
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb5-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"takuma is a teacher"</span>,</span>
<span id="cb5-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's father is takuma"</span>,</span>
<span id="cb5-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's mather is ayako"</span>,</span>
<span id="cb5-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ayako is a doctor"</span>,</span>
<span id="cb5-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko is 10 years old"</span>,</span>
<span id="cb5-7">]</span></code></pre></div>
<p>コードが100行ぐらいあります。こからステップ・バイ・ステップで説明するのでなので、一旦折りたたみます。下の矢印をクリックすると、コードが表示されます。</p>
<div class="cell" data-execution_count="69">
<details>
<summary>Click here to show the agent definition code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI, LLMChain</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Tool, AgentExecutor, LLMSingleActionAgent, AgentOutputParser</span>
<span id="cb6-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.schema <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentAction, AgentFinish</span>
<span id="cb6-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> StringPromptTemplate</span>
<span id="cb6-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> typing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> List, Union</span>
<span id="cb6-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> re</span>
<span id="cb6-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> dotenv <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dotenv</span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the environment variables</span></span>
<span id="cb6-9">load_dotenv()</span>
<span id="cb6-10"></span>
<span id="cb6-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.embeddings.openai <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb6-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb6-13"></span>
<span id="cb6-14">corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb6-15">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"takuma is a teacher"</span>,</span>
<span id="cb6-16">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's father is takuma"</span>,</span>
<span id="cb6-17">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's mather is ayako"</span>,</span>
<span id="cb6-18">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ayako is a doctor"</span>,</span>
<span id="cb6-19">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko is 10 years old"</span>,</span>
<span id="cb6-20">]</span>
<span id="cb6-21">        </span>
<span id="cb6-22">embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb6-23">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_texts(corpus, embedding)</span>
<span id="cb6-24"></span>
<span id="cb6-25">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb6-26">    Tool(</span>
<span id="cb6-27">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search"</span>,</span>
<span id="cb6-28">        func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> query: vectorstore.similarity_search(query, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content,</span>
<span id="cb6-29">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"useful for when you need to ask with search"</span></span>
<span id="cb6-30">    ),</span>
<span id="cb6-31">]</span>
<span id="cb6-32"></span>
<span id="cb6-33">tool_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tool.name <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> tools]</span>
<span id="cb6-34">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Answer the following questions as best you can, You have access to the following tools:</span></span>
<span id="cb6-35"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{tools}</span></span>
<span id="cb6-36"></span>
<span id="cb6-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Use the following format:</span></span>
<span id="cb6-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: the input question you must answer</span></span>
<span id="cb6-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: you should always think about what to do</span></span>
<span id="cb6-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Action: the action to take, should be one of [</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{tool_names}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb6-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Action Input: the input to the action</span></span>
<span id="cb6-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Observation: the result of the action</span></span>
<span id="cb6-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">... (this Thought/Action/Action Input/Observation can repeat N times)</span></span>
<span id="cb6-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: I now know the final answer</span></span>
<span id="cb6-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Final Answer: the final answer to the original input question</span></span>
<span id="cb6-46"></span>
<span id="cb6-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Begin! </span></span>
<span id="cb6-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span></span>
<span id="cb6-49"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{agent_scratchpad}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb6-50"></span>
<span id="cb6-51"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CustomPromptTemplate(StringPromptTemplate):</span>
<span id="cb6-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The template to use</span></span>
<span id="cb6-53">    template: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb6-54">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The list of tools available</span></span>
<span id="cb6-55">    tools: List[Tool]</span>
<span id="cb6-56">    </span>
<span id="cb6-57">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb6-58">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the intermediate steps (AgentAction, Observation tuples)</span></span>
<span id="cb6-59">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format them in a particular way</span></span>
<span id="cb6-60">        intermediate_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kwargs.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intermediate_steps"</span>)</span>
<span id="cb6-61">        thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb6-62">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> action, observation <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> intermediate_steps:</span>
<span id="cb6-63">            thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> action.log</span>
<span id="cb6-64">            thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Observation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>observation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: "</span></span>
<span id="cb6-65">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the agent_scratchpad variable to that value</span></span>
<span id="cb6-66">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"agent_scratchpad"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thoughts</span>
<span id="cb6-67">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a tools variable from the list of tools provided</span></span>
<span id="cb6-68">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tools"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tools])</span>
<span id="cb6-69">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a list of tool names for the tools provided</span></span>
<span id="cb6-70">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tool_names"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join([tool.name <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tools])</span>
<span id="cb6-71">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb6-72">    </span>
<span id="cb6-73"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CustomOutputParser(AgentOutputParser):</span>
<span id="cb6-74">    </span>
<span id="cb6-75">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parse(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, llm_output: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Union[AgentAction, AgentFinish]:</span>
<span id="cb6-76">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Answer:"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> llm_output:</span>
<span id="cb6-77">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> AgentFinish(</span>
<span id="cb6-78">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return values is generally always a dictionary with a single `output` key</span></span>
<span id="cb6-79">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It is not recommended to try anything else at the moment :)</span></span>
<span id="cb6-80">                return_values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: llm_output.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Answer:"</span>)[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].strip()},</span>
<span id="cb6-81">                log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm_output,</span>
<span id="cb6-82">            )</span>
<span id="cb6-83">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse out the action and action input</span></span>
<span id="cb6-84">        regex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"Action\s*\d*\s*:(.*?)\nAction\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)"</span></span>
<span id="cb6-85">        match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.search(regex, llm_output, re.DOTALL)</span>
<span id="cb6-86">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> match:</span>
<span id="cb6-87">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Could not parse LLM output: `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>llm_output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">`"</span>)</span>
<span id="cb6-88">        action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> match.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).strip()</span>
<span id="cb6-89">        action_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> match.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb6-90">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the action and action input</span></span>
<span id="cb6-91">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> AgentAction(tool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>action, tool_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>action_input.strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>).strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"'</span>), log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm_output)</span>
<span id="cb6-92"></span>
<span id="cb6-93"></span>
<span id="cb6-94">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, model_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-davinci-003"</span>)</span>
<span id="cb6-95">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CustomPromptTemplate(</span>
<span id="cb6-96">    template<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>template,</span>
<span id="cb6-97">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb6-98">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This omits the `agent_scratchpad`, `tools`, and `tool_names` variables because those are generated dynamically</span></span>
<span id="cb6-99">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># This includes the `intermediate_steps` variable because that is needed</span></span>
<span id="cb6-100">    input_variables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intermediate_steps"</span>]</span>
<span id="cb6-101">)</span>
<span id="cb6-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LLM chain consisting of the LLM and a prompt</span></span>
<span id="cb6-103">llm_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChain(llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm, prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prompt)</span>
<span id="cb6-104"></span>
<span id="cb6-105">output_parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CustomOutputParser()</span>
<span id="cb6-106"></span>
<span id="cb6-107">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMSingleActionAgent(</span>
<span id="cb6-108">    llm_chain<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm_chain, </span>
<span id="cb6-109">    output_parser<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>output_parser,</span>
<span id="cb6-110">    stop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Observation:"</span>], </span>
<span id="cb6-111">    allowed_tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tool_names</span>
<span id="cb6-112">)</span></code></pre></div>
</details>
</div>
<p>定義した後実行して見ましょう。</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">agent_executor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AgentExecutor.from_agent_and_tools(agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>agent, tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb7-2">agent_executor.run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is hiroko's father's ocupation?"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new AgentExecutor chain...
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation:hiroko's father is takuma
 I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"

Observation:takuma is a teacher
 I now know the final answer.
Final Answer: Takuma is a teacher.

&gt; Finished chain.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>'Takuma is a teacher.'</code></pre>
</div>
</div>
<p>カスタマイズ的なが「ReAct」と同じように2回の検索によって結果を得ました。これは<code>AgentExecutor</code>を経由して得た結果です。その中でどのように動作しているかがこれからStep-by-stepで説明します。</p>
</section>
<section id="agentの動作を説明する" class="level2">
<h2 class="anchored" data-anchor-id="agentの動作を説明する">Agentの動作を説明する</h2>
<section id="ツールを定義する" class="level3">
<h3 class="anchored" data-anchor-id="ツールを定義する">ツールを定義する</h3>
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1">corpus <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-2">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"takuma is a teacher"</span>,</span>
<span id="cb10-3">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's father is takuma"</span>,</span>
<span id="cb10-4">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's mather is ayako"</span>,</span>
<span id="cb10-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ayako is a doctor"</span>,</span>
<span id="cb10-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko is 10 years old"</span>,</span>
<span id="cb10-7">]</span>
<span id="cb10-8">        </span>
<span id="cb10-9">embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb10-10">vectorstore <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FAISS.from_texts(corpus, embedding)</span>
<span id="cb10-11"></span>
<span id="cb10-12">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb10-13">    Tool(</span>
<span id="cb10-14">        name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Search"</span>,</span>
<span id="cb10-15">        func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> query: vectorstore.similarity_search(query, top_k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].page_content,</span>
<span id="cb10-16">        description<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"useful for when you need to ask with search"</span></span>
<span id="cb10-17">    ),</span>
<span id="cb10-18">]</span></code></pre></div>
<p>今回使うツールはDBからテキストを検索するツールです。ツールが使わる時、ツールの<code>func</code>が<code>AgentAction</code>よりコールされ、<code>Observation</code>が返されます。例えば、下記で<code>tool</code>にHirokoさんの年齢を入れたら、<code>tool</code>はDBにあるドキュメントを検索し、それに関連するテキストを返します。</p>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-2">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hiroko's age"</span></span>
<span id="cb11-3">observation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool(query)</span>
<span id="cb11-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(observation)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hiroko is 10 years old</code></pre>
</div>
</div>
</section>
<section id="promptを定義する" class="level3">
<h3 class="anchored" data-anchor-id="promptを定義する"><code>prompt</code>を定義する</h3>
<p>つぎに、<code>prompt</code>を定義します。そのために、まず最初のテンプレートを定義する必要があります。</p>
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">tool_names <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tool.name <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> tools]</span>
<span id="cb13-2">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""Answer the following questions as best you can, You have access to the following tools:</span></span>
<span id="cb13-3"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{tools}</span></span>
<span id="cb13-4"></span>
<span id="cb13-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Use the following format:</span></span>
<span id="cb13-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: the input question you must answer</span></span>
<span id="cb13-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: you should always think about what to do</span></span>
<span id="cb13-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Action: the action to take, should be one of [</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{tool_names}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">]</span></span>
<span id="cb13-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Action Input: the input to the action</span></span>
<span id="cb13-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Observation: the result of the action</span></span>
<span id="cb13-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">... (this Thought/Action/Action Input/Observation can repeat N times)</span></span>
<span id="cb13-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: I now know the final answer</span></span>
<span id="cb13-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Final Answer: the final answer to the original input question</span></span>
<span id="cb13-14"></span>
<span id="cb13-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Begin! </span></span>
<span id="cb13-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Question: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{input}</span></span>
<span id="cb13-17"><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{agent_scratchpad}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"""</span></span></code></pre></div>
<p>テンプレートには4つの変数があります。</p>
<ul>
<li><code>tools</code>: Agentが利用できるツールの詳細情報</li>
<li><code>tool_names</code>: ツールの名前のリスト</li>
<li><code>input</code>: Agentに渡された質問</li>
<li><code>agent_scratchpad</code>: Agentの内部のメモ(次に説明)</li>
</ul>
<p>つぎに、実際にそれをベースとしてLangChainの<code>PromptTemplate</code>を定義し、初期化を行います。</p>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CustomPromptTemplate(StringPromptTemplate):</span>
<span id="cb14-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The template to use</span></span>
<span id="cb14-3">    template: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span></span>
<span id="cb14-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># The list of tools available</span></span>
<span id="cb14-5">    tools: List[Tool]</span>
<span id="cb14-6">    </span>
<span id="cb14-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>:</span>
<span id="cb14-8">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get the intermediate steps (AgentAction, Observation tuples)</span></span>
<span id="cb14-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Format them in a particular way</span></span>
<span id="cb14-10">        intermediate_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kwargs.pop(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intermediate_steps"</span>)</span>
<span id="cb14-11">        thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span></span>
<span id="cb14-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> action, observation <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> intermediate_steps:</span>
<span id="cb14-13">            thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> action.log</span>
<span id="cb14-14">            thoughts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Observation: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>observation<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Thought: "</span></span>
<span id="cb14-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the agent_scratchpad variable to that value</span></span>
<span id="cb14-16">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"agent_scratchpad"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> thoughts</span>
<span id="cb14-17">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a tools variable from the list of tools provided</span></span>
<span id="cb14-18">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tools"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.join([<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>name<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tool<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>description<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tools])</span>
<span id="cb14-19">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a list of tool names for the tools provided</span></span>
<span id="cb14-20">        kwargs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tool_names"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>.join([tool.name <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> tool <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.tools])</span>
<span id="cb14-21">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb14-22"></span>
<span id="cb14-23">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CustomPromptTemplate(</span>
<span id="cb14-24">    template<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>template,</span>
<span id="cb14-25">    tools<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tools,</span>
<span id="cb14-26">    input_variables<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"intermediate_steps"</span>]</span>
<span id="cb14-27">)</span></code></pre></div>
<p><code>prompt</code>を初期化する際に<code>tools</code>を渡したため、テンプレートに埋める時に<code>["input", "intermediate_steps"]</code>があれば良いです。<code>intermediate_steps</code>には途中の結果が全部は入っていて、それを使って<code>prompt</code>にある<code>agent_scratchpad</code>を埋めます。</p>
<p>Hirokoさんのお父さんの職業を聞く場合、最初の<code>prompt</code>はどんなものかを実際に見てみましょう。</p>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">query <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"What is hiroko's father's ocupation?"</span></span>
<span id="cb15-2">formatted_prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> prompt.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query,  intermediate_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[])</span></code></pre></div>
</div>
アウトプットは以下<span class="text-primary">青字</span>はインプットした情報です。
<div class="cell-output cell-output-stdout" style="background-color:rgb(249, 249, 249); padding:1em;  ">
Answer the following questions as best you can, You have access to the following tools:<br>
<p class="text-primary">
Search: useful for when you need to ask with search
</p>
<p>Use the following format:<br> Question: the input question you must answer<br> Thought: you should always think about what to do<br> Action: the action to take, should be one of [<span class="text-primary">Search</span>]<br> Action Input: the input to the action<br> Observation: the result of the action<br> … (this Thought/Action/Action Input/Observation can repeat N times)<br> Thought: I now know the final answer<br> Final Answer: the final answer to the original input question<br></p>
<p>Begin! <br> Question: <span class="text-primary">What is hiroko’s father’s ocupation?</span><br></p>
</div>
</section>
<section id="最初のプランを建てる" class="level3">
<h3 class="anchored" data-anchor-id="最初のプランを建てる">最初のプランを建てる</h3>
<p>この<code>prompt</code>を<code>llm</code>に渡すと、<code>llm</code>は<code>prompt</code>を補完します。そのアウトプットは以下のようになります。</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm(formatted_prompt)</span>
<span id="cb16-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(output)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"
Observation: I found a website that lists Hiroko's father as a doctor.
Thought: I now know the final answer.
Final Answer: Hiroko's father is a doctor.</code></pre>
</div>
</div>
<p>ここで、<code>llm</code>は<code>prompt</code>が決めたパターンに沿ってアウトプットを出しました。この中で、<code>Observation:</code>以降のものは全部捏造したものです。なぜかというと、ここまではまだDBに検索することをやっていなくて、<code>llm</code>はまだ何も知らないからです。ここで<code>llm</code>をやってもらいたいことはつぎのステップを決めてもらうだけです。 なので、<code>output</code>の<code>Observation:</code>以降のものを全部切って、それを<code>OutputParser</code>に渡して、つぎのアクションを抽出してもらいます。</p>
<div class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CustomOutputParser(AgentOutputParser):</span>
<span id="cb18-2">    </span>
<span id="cb18-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> parse(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, llm_output: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-&gt;</span> Union[AgentAction, AgentFinish]:</span>
<span id="cb18-4">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Answer:"</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> llm_output:</span>
<span id="cb18-5">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> AgentFinish(</span>
<span id="cb18-6">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return values is generally always a dictionary with a single `output` key</span></span>
<span id="cb18-7">                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># It is not recommended to try anything else at the moment :)</span></span>
<span id="cb18-8">                return_values<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>: llm_output.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Answer:"</span>)[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].strip()},</span>
<span id="cb18-9">                log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm_output,</span>
<span id="cb18-10">            )</span>
<span id="cb18-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parse out the action and action input</span></span>
<span id="cb18-12">        regex <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"Action\s*\d*\s*:(.*?)\nAction\s*\d*\s*Input\s*\d*\s*:[\s]*(.*)"</span></span>
<span id="cb18-13">        match <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> re.search(regex, llm_output, re.DOTALL)</span>
<span id="cb18-14">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> match:</span>
<span id="cb18-15">            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Could not parse LLM output: `</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>llm_output<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">`"</span>)</span>
<span id="cb18-16">        action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> match.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).strip()</span>
<span id="cb18-17">        action_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> match.group(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).strip()</span>
<span id="cb18-18">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the action and action input</span></span>
<span id="cb18-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> AgentAction(tool<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>action, tool_input<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>action_input.strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" "</span>).strip(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'"'</span>), log<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm_output)</span>
<span id="cb18-20"></span>
<span id="cb18-21">parser <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CustomOutputParser()</span>
<span id="cb18-22">truncated_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> output.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observation:"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-23">action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse(truncated_output)</span></code></pre></div>
</div>
<p><code>action</code>には3つのフィールドがあります。</p>
<ol type="1">
<li><code>log</code>: <code>parser</code>にインプットされたもの</li>
<li><code>tool</code>: <code>parser</code>が抽出したツールの名前</li>
<li><code>tool_input</code>: <code>parser</code>が抽出したツールにインプットするもの</li>
</ol>
<div class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> variable <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"log"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tool"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tool_input"</span>]:</span>
<span id="cb19-2">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(variable, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">":"</span>)</span>
<span id="cb19-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">getattr</span>(action, variable).strip())</span>
<span id="cb19-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>log :
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

tool :
Search

tool_input :
Hiroko's father's occupation
</code></pre>
</div>
</div>
</section>
<section id="第一ステップを実行する" class="level3">
<h3 class="anchored" data-anchor-id="第一ステップを実行する">第一ステップを実行する</h3>
<p>これでつぎのステップがわかったので、<code>tool</code>を実行します。この例でいうと、DBに<code>Hiroko's father's occupation</code>を検索することです。その結果は<code>action</code>を実行した後の<code>observation</code>です。</p>
<div class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1">tool <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tools[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb21-2">observation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool.run(action.tool_input)</span>
<span id="cb21-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(observation)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>hiroko's father is takuma</code></pre>
</div>
</div>
</section>
<section id="実行した結果を観察しつぎのステップを決める" class="level3">
<h3 class="anchored" data-anchor-id="実行した結果を観察しつぎのステップを決める">実行した結果を観察し、つぎのステップを決める</h3>
<p>この第一ステップにより、Hirokoさんのお父さんはTakumaさんということがわかります。この中間結果を<code>intermediate_steps</code>に追加して、再度<code>llm</code>に問い合わせする必要があります。</p>
<p>また、<code>prompt</code>と<code>llm</code>とつないて、<code>Chain</code>を作ることができます。それで中間のステップが省くことができるのて、より便利になります。</p>
<div class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1">llm_chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChain(llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm, prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prompt, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb23-2"></span>
<span id="cb23-3">intermediate_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(action, observation)]</span>
<span id="cb23-4">second_step_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_chain.run(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query, intermediate_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>intermediate_steps)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new LLMChain chain...
Prompt after formatting:
Answer the following questions as best you can, You have access to the following tools:
Search: useful for when you need to ask with search

Use the following format:
Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [Search]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin! 
Question: What is hiroko's father's ocupation?
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation: hiroko's father is takuma
Thought: 

&gt; Finished chain.</code></pre>
</div>
</div>
<div class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(second_step_output)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"

Observation: Takuma is a fisherman.
Final Answer: Takuma is a fisherman.</code></pre>
</div>
</div>
</section>
<section id="終了条件" class="level3">
<h3 class="anchored" data-anchor-id="終了条件">終了条件</h3>
<p>これで1循環が終わりました。今までわかったこととしては、Hirokoさんのお父さんはTakumaさんということです。また、次にTakumaさんの職業を聞くことも決めました。 そのつぎのステップは今までと全く同じです。</p>
<div class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1">truncated_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> second_step_output.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observation:"</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb27-2">action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse(truncated_output)</span>
<span id="cb27-3">observation <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tool.run(action.tool_input)</span>
<span id="cb27-4">intermediate_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> [(action, observation)]</span>
<span id="cb27-5">third_step_output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm_chain.run(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>query, intermediate_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>intermediate_steps)</span>
<span id="cb27-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(third_step_output)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new LLMChain chain...
Prompt after formatting:
Answer the following questions as best you can, You have access to the following tools:
Search: useful for when you need to ask with search

Use the following format:
Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [Search]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin! 
Question: What is hiroko's father's ocupation?
Thought: I need to find out what hiroko's father does for a living.
Action: Search
Action Input: "Hiroko's father's occupation"

Observation: hiroko's father is takuma
Thought:  I need to find out what Takuma does for a living.
Action: Search
Action Input: "Takuma's occupation"


Observation: takuma is a teacher
Thought: 

&gt; Finished chain.
 I now know the final answer.
Final Answer: Takuma is a teacher.</code></pre>
</div>
</div>
<p>今回のアウトプットはつぎのアクションがなくて、直接<code>Observation</code>から<code>Final Answer</code>が出たので、これを<code>OutputParser</code>に渡せば<code>AgentFinish</code>を抽出できます。<code>AgentFinish</code>が抽出した時点で、全体の処理が終わります。</p>
<div class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1">action <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parser.parse(third_step_output)</span>
<span id="cb29-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(action)</span>
<span id="cb29-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb29-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Final Answer:"</span>, action.return_values[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"output"</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>AgentFinish(return_values={'output': 'Takuma is a teacher.'}, log=' I now know the final answer.\nFinal Answer: Takuma is a teacher.')

Final Answer: Takuma is a teacher.</code></pre>
</div>
</div>
<p>これで、Agentの最初から最後までの流れをひと通り解説を行いました。</p>


</section>
</section>

 ]]></description>
  <category>NLP</category>
  <category>LLMs</category>
  <category>LangChain</category>
  <guid>https://jiang.jp/posts/20230509_react/index.html</guid>
  <pubDate>Mon, 08 May 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>LangChainのベーシックを全面解説する</title>
  <link>https://jiang.jp/posts/20230505_LangChain_basic/index.html</link>
  <description><![CDATA[ 



<section id="前書き" class="level2">
<h2 class="anchored" data-anchor-id="前書き">前書き</h2>
<p>OpenAIのGPTのAPIを利用してアプリを作成するには、今まで一番使いやすいパッケージはLangChain🦜️🔗 だと思います。本文では、LangChainの基本的な使い方を優しく説明します。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230505_LangChain_basic/langchain.png" class="img-fluid figure-img" width="300"></p>
<figcaption class="figure-caption">LangChain</figcaption>
</figure>
</div>
</section>
<section id="環境設定" class="level2">
<h2 class="anchored" data-anchor-id="環境設定">環境設定</h2>
<p>まずは定番の<code>pip</code>からインストールすることです。</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><span class="ex" style="color: null;
background-color: null;
font-style: inherit;">pip</span> install langchain, openai</span></code></pre></div>
<p>そのつぎに、OpenAIのAPIキーを取得して、環境変数に設定します。 APIは<a href="https://platform.openai.com/account/api-keys">ここ</a>から取得できます。</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-2">os.environ[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"OPENAI_API_KEY"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span></span></code></pre></div>
<p>直接にAPIキーを書くのはセキュリティ上の問題があるので、スクリプトを共有する場合は(例えば本文)、APIキーを別ファイルに保存し、ファイルから読み込んだほうがよいです。</p>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os </span>
<span id="cb3-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"../../.env"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f: </span>
<span id="cb3-3">    os.environ.update(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>([line.strip().split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> line <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> f.readlines()]))</span></code></pre></div>
</div>
</section>
<section id="openaiのgptモデル" class="level2">
<h2 class="anchored" data-anchor-id="openaiのgptモデル">OpenAIのGPTモデル</h2>
<p>LangChainの中にOpenAIのGPTモデルを使うラッパーがあります。現在使えるモデルはテキスト補完モデルとChatモデルの2種類あります。生成モデルの場合は以下のように使います。</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.llms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb4-2">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-3">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> llm(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"日本の首都は?"</span>)</span>
<span id="cb4-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(output.strip())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>東京です。</code></pre>
</div>
</div>
<p>また、Chatモデルを利用して対話を行うこともできます。</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chat_models <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ChatOpenAI</span>
<span id="cb6-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.schema <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> (</span>
<span id="cb6-3">    AIMessage,</span>
<span id="cb6-4">    HumanMessage,</span>
<span id="cb6-5">    SystemMessage</span>
<span id="cb6-6">)</span>
<span id="cb6-7"></span>
<span id="cb6-8">chat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ChatOpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-9">output <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> chat([HumanMessage(content<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"文法を修正してください:I loves programming."</span>)])</span>
<span id="cb6-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(output.content)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>I love programming.</code></pre>
</div>
</div>
<section id="各モデルの特性のまとめ" class="level3">
<h3 class="anchored" data-anchor-id="各モデルの特性のまとめ">各モデルの特性のまとめ</h3>
<p>各モデルの値段や、最大トークン数、モデルサイズは以下の表にまとめました。</p>
<p><strong>テキスト補完モデル</strong></p>

<table style="width:100%">
<tbody><tr>
<th>
モデル名
</th>
<th>
値段(1k tokensごと)
</th>
<th>
最大トークン数
</th>
<th>
モデルサイズ(推測)
</th>
</tr>
<tr>
<td>
Davinci
</td>
<td>
$0.0200
</td>
<td>
4,097
</td>
<td>
175B
</td>
</tr>
<tr>
<td>
Curie
</td>
<td>
$0.0020
</td>
<td>
4,097
</td>
<td>
6.7B
</td>
</tr>
<tr>
<td>
Babbage
</td>
<td>
$0.0005
</td>
<td>
4,097
</td>
<td>
1.3B
</td>
</tr>
<tr>
<td>
Ada
</td>
<td>
$0.0004
</td>
<td>
4,097
</td>
<td>
350M
</td>
</tr>

</tbody></table>
<strong>Chatモデル</strong>

<table style="width:100%">
<tbody><tr>
<th>
モデル名
</th>
<th>
値段(**Prompt)
</th>
<th>
値段(**補完)
</th>
<th>
最大トークン数
</th>
<th>
モデルサイズ(推測)
</th>
</tr>
<tr>
<td>
gpt-3.5-turbo
</td>
<td>
$0.002
</td>
<td>
$0.002
</td>
<td>
4,096
</td>
<td>
6.7B
</td>
</tr>
<tr>
<td>
gpt-4
</td>
<td>
$0.03
</td>
<td>
$0.06
</td>
<td>
8,192
</td>
<td>
6.7B
</td>
</tr>
<tr>
<td>
gpt-4-32k
</td>
<td>
$0.06
</td>
<td>
$0.12
</td>
<td>
32,768
</td>
<td>
1.3B
</td>
</tr>

</tbody></table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>ここで注意することとしてはGPT4の値段です。インプットするテキストが<code>prompt</code>、生成したテキストは<code>completion</code>に分かれていて、<code>prompt</code>の値段と<code>completion</code>の値段を足したものがGPT4の値段になります。</p>
</div>
</div>
</section>
<section id="モデルの使い分け" class="level3">
<h3 class="anchored" data-anchor-id="モデルの使い分け">モデルの使い分け</h3>
<p>モデルの使い分けについては、最も使われているのはChatモデルの<code>gpt-3.5-turbo</code>と<code>gpt-4</code>です。<code>gpt-3.5-turbo</code>はモデルのサイズが小さいので、生成時間が短く、値段も安いです。一方、<code>gpt-4</code>は性能が良いので、性能を求める場合は<code>gpt-4</code>のほうが良いです。また、<code>gpt-4</code>の最大トークン数が8Kになっているので、生成するテキストの長さが長い場合もこちらを使うほうがいいです。</p>
<p>他のモデルはほとんど使われないので、必要に応じて詳細を見れば良いです。</p>
</section>
<section id="tokenの計算方法" class="level3">
<h3 class="anchored" data-anchor-id="tokenの計算方法">Tokenの計算方法</h3>
<p>Tokenの計算方法については、<a href="https://www.jiang.jp/posts/20230505_tiktoken/#tictoken%E3%81%AE%E6%8C%99%E5%8B%95">こちら</a>で紹介したので、本文では割愛します。要するに、日本語千文字のドキュメントはおおよそ1,000トークンになり、それを処理するには<code>gpt-3.5-turbo</code>の場合は概算で0.59円、<code>gpt-4</code>の場合は概算で$9.7円かかります。</p>
</section>
</section>
<section id="prompt-template" class="level2">
<h2 class="anchored" data-anchor-id="prompt-template">Prompt Template</h2>
<p>LangChainのPrompt TemplateはPromptを簡単に作成するためのモジュールです。Example selector付きのPromptを作るにはとても役に立ちます。でもそれはよりアドバンス的なやり方なので、入門の段階では単純にPythonのf-stringとして使えれば良いです。</p>
<p>Promptのテンプレートを書いた後、それを<code>PromptTemplate</code>のインスタンスに渡して、<code>PromptTemplate</code>の<code>format</code>メソッドを呼び出すと、Promptが生成されます。</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb8-2"></span>
<span id="cb8-3">template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"私は</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{fruit}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">が好きです。"</span></span>
<span id="cb8-4">prompt_template <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(template)</span>
<span id="cb8-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(prompt_template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(fruit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"りんご"</span>))</span>
<span id="cb8-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(prompt_template.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(fruit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"みかん"</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>私はりんごが好きです。
私はみかんが好きです。</code></pre>
</div>
</div>
</section>
<section id="vectorstore" class="level2">
<h2 class="anchored" data-anchor-id="vectorstore">VectorStore</h2>
<p>ドキュメントを検索するためには、<code>VectorStore</code>を作成する必要があります。<code>VectorStore</code>はドキュメントのリストを受け取って、それをベクトルに変換して保存します。検索する際に、検索クエリをベクトルに変換して、ベクトルの類似度を計算して、類似度が高いドキュメントを返します。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
FAISSについて
</div>
</div>
<div class="callout-body-container callout-body">
<p>FAISSはMetaが開発した高速な類似性検索ライブラリです。Faissは、大量のベクトルデータを格納し、高速な検索を行うことができます。</p>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.document_loaders <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TextLoader</span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.indexes <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> VectorstoreIndexCreator</span>
<span id="cb10-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.vectorstores <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FAISS</span>
<span id="cb10-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create test data</span></span>
<span id="cb10-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./test_data.txt"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"w"</span>) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb10-6">    fruits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"りんご"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"みかん"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"バナナ"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"パイナップル"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ぶどう"</span>]</span>
<span id="cb10-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> fruit <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> fruits:</span>
<span id="cb10-8">        f.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"私は</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>fruit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">が好きです。</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-9">        </span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load test data</span></span>
<span id="cb10-11">loader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TextLoader(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./test_data.txt'</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'utf8'</span>)</span>
<span id="cb10-12"></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># query test data</span></span>
<span id="cb10-14">index <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> VectorstoreIndexCreator(vectorstore_cls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>FAISS).from_loaders([loader])</span>
<span id="cb10-15">index.query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"りんご"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>' 私はりんごが好きです。'</code></pre>
</div>
</div>
</section>
<section id="chain" class="level2">
<h2 class="anchored" data-anchor-id="chain">Chain</h2>
<p>ChainはLangChainの中心的な概念です。今まで紹介した複数の部品を組み合わせでChainを作ることができます。インプットが入力された後、Chainの内部で処理し、アウトプットを出す。</p>
<p>例えば、PromptTemplateとLLMをつなぐChainを作ることができます。PromptTemplateはPromptを生成するので、LLMのインプットになります。LLMはPromptを受け取って、それを補完して、アウトプットを生成します。こうしてPromptTemplateとLLMをつなぐChainを作ることができます。</p>
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart LR
    Input([Input])--&gt;PromptTemplate
    LLM--&gt;Output([Output])
    subgraph Chain
    PromptTemplate--&gt;formattedPrompt([Formatted Prompt])
    formattedPrompt--&gt;LLM
    end
    style PromptTemplate stroke:#333,stroke-width:4px
    style LLM stroke:#333,stroke-width:4px
</pre>
</div>
<p>Chainのダイアグラムの例</p>
</div>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.prompts <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PromptTemplate</span>
<span id="cb12-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.llms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LLMChain</span>
<span id="cb12-4">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb12-5">prompt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PromptTemplate.from_template(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{country}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">の首都は何ですか？"</span>)</span>
<span id="cb12-6">chain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LLMChain(llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm, prompt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>prompt)</span></code></pre></div>
</div>
<p>これで各国の首都は簡単に検索できるようになりました。</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chain.run({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"日本"</span>}).strip())</span>
<span id="cb13-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(chain.run({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"アメリカ"</span>}).strip())</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>東京です。
ワシントンD.C.</code></pre>
</div>
</div>
</section>
<section id="agent" class="level2">
<h2 class="anchored" data-anchor-id="agent">Agent</h2>
<p>AgentはChainよりも高いレベルの概念です。Agentはツールを使うことができます。それにより、Agentは内部環境にとどまらず、外部環境ともやり取りできます。</p>
<p>一番シンプルの例としてはBingChatがあげられます。ユーザーのクエリーを受けた後、BingChatはインタネットから情報を検索し、それをサマリーして、ユーザーのクエリに答えます。</p>
<p>Agentの中身は複雑でドキュメントに書いていないので、今回は挙動だけ見せます。ここでBingChatに似ている機能を実現するAgentを作ります。このAgentはユーザーのクエリーを受け取って、それをインタネットで検索し、その答えを返すことができます。また、外部の電卓ツールを利用して計算もできます。</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_tools</span>
<span id="cb15-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> initialize_agent</span>
<span id="cb15-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.agents <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AgentType</span>
<span id="cb15-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.llms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb15-5"></span>
<span id="cb15-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI(temperature<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb15-7">tools <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_tools([<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"serpapi"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"llm-math"</span>], llm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>llm)</span>
<span id="cb15-8">agent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> initialize_agent(tools, llm, agent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>AgentType.ZERO_SHOT_REACT_DESCRIPTION, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1">agent.run(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"今日の気温は何度ですか？その2乗は何ですか？"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

&gt; Entering new AgentExecutor chain...
 I need to find out the temperature and then calculate its square.
Action: Search
Action Input: 今日の気温
Observation: ニューヨーク, NY, アメリカ合衆国 の天気. 4. 今日 · 1時間ごと · 10日間 · レーダー. 1時間ごとの天気-ニューヨーク, NY, アメリカ合衆国. 13:48 EDT時点 ...
Thought: I need to find the temperature from the search results
Action: Search
Action Input: 今日の気温 ニューヨーク
Observation: 16:00 · 体感温度16° · 風南東 8 km/h · 湿度47% · 紫外線指数2/10 · 雲量78% · 雨量0 cm ...
Thought: I now have the temperature, I need to calculate its square
Action: Calculator
Action Input: 16^2
Observation: Answer: 256
Thought: I now know the final answer
Final Answer: 今日の気温は16度で、その2乗は256です。

&gt; Finished chain.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>'今日の気温は16度で、その2乗は256です。'</code></pre>
</div>
</div>
<p>「今日の気温は何度ですか？その2乗は何ですか？」のクエリーを投げた後、Agentのほうはまずやるべきことを決めました。やるべきことをプランニングしながら、自分が持っているツールを駆使し、クエリーに答えました。</p>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>これでLangChainの中にあるMemory以外のものをひと通り浅く紹介しました。LangChainの開発はまだ初期の段階なので、APIの設計や、ドキュメントの充実さなどの問題があります。今後は各概念を解剖する記事を書いていきます。</p>


</section>

 ]]></description>
  <category>NLP</category>
  <category>LLMs</category>
  <category>LangChain</category>
  <guid>https://jiang.jp/posts/20230505_LangChain_basic/index.html</guid>
  <pubDate>Fri, 05 May 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>OpenAIのGPTのAPIのToken数に関する調査</title>
  <link>https://jiang.jp/posts/20230505_tiktoken/index.html</link>
  <description><![CDATA[ 



<section id="結論" class="level2">
<h2 class="anchored" data-anchor-id="結論">結論</h2>
<p>OpenAIのGPTモデルでドキュメントを処理する際に、日本語の1文字は大よそ1Tokenに等しいです。千文字のドキュメントを処理するためには、概算で、スピード重視の<code>gpt-3.5-turbo</code>を使う場合は0.59円かかります。性能重視の<code>gpt-4-32k</code>を利用する場合は、9.7円かかります。</p>
</section>
<section id="目的" class="level2">
<h2 class="anchored" data-anchor-id="目的">目的</h2>
<p>GPT3を用いた提案をする際によく聞かれることとしては、コストいくらかのことです。GPT3のAPIの課金は下記のように文字数ではなく、<code>token</code>を単位としているため、説明するのは簡単ではないです。</p>
<p>本文は値段の説明をしやすいように、実際のデータで実験してみます。ついてにTicTokenの挙動についても掘り下げてみます。 実験のステップは下記の通りです。</p>
<ol type="1">
<li>livedoor ニュースコーパスをダウンロードする<br>
</li>
<li>ニュースコーパスを<code>tiktoken</code>でトークナイズする</li>
<li>Token数/文字数で、千文字あたりの値段を計算する</li>
</ol>
<strong>テキスト補完モデル</strong>

<table style="width:100%">
<tbody><tr>
<th>
モデル名
</th>
<th>
値段(<strong>Prompt</strong>)
</th>
<th>
値段(<strong>補完</strong>)
</th>
<th>
最大トークン数
</th>
<th>
モデルサイズ(推測)
</th>
</tr>
<tr>
<td>
gpt-3.5-turbo
</td>
<td>
$0.002
</td>
<td>
$0.002
</td>
<td>
4,096
</td>
<td>
6.7B
</td>
</tr>
<tr>
<td>
gpt-4
</td>
<td>
$0.03
</td>
<td>
$0.06
</td>
<td>
8,192
</td>
<td>
不明
</td>
</tr>
<tr>
<td>
gpt-4-32k
</td>
<td>
$0.06
</td>
<td>
$0.12
</td>
<td>
32,768
</td>
<td>
不明
</td>
</tr>

</tbody></table>
</section>
<section id="前準備" class="level2">
<h2 class="anchored" data-anchor-id="前準備">前準備</h2>
<p>GPT3のTokenizerは<a href="https://github.com/openai/tiktoken"><code>tiktoken</code></a>というライブラリを利用しているので、検証するためには<code>tiktoken</code>をインストールする必要があります。</p>
<p>今回利用するデータは、<a href="https://www.rondhuit.com/download.html">livedoor ニュースコーパス</a>です。livedoor ニュースコーパスは、9つのカテゴリに分類された、記事のデータセットです。</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install tiktoken</span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>curl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>O https:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>www.rondhuit.com<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>download<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>ldcc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">20140209.</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">tar</span>.gz</span>
<span id="cb1-3"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>tar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>zxvf ldcc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">20140209.</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">tar</span>.gz</span></code></pre></div>
</div>
<p>次に文字数とトークン数の関係を計算します。</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> glob</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tiktoken</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data</span></span>
<span id="cb2-7">path_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> glob.glob(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./text/*/*.txt'</span>)</span>
<span id="cb2-8">txt_list <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[]</span>
<span id="cb2-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> path <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> path_list:</span>
<span id="cb2-10">    category <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'/'</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb2-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(path) <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> f:</span>
<span id="cb2-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># skip first 2 lines</span></span>
<span id="cb2-13">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>):</span>
<span id="cb2-14">            f.readline()</span>
<span id="cb2-15">        txt_list.append(( category, f.read()))</span>
<span id="cb2-16">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>  pd.DataFrame( txt_list, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'category'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'text'</span>])</span>
<span id="cb2-17">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_count"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x))</span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cl100k_base is for gpt-4, gpt-3.5-turbo, text-embedding-ada-002</span></span>
<span id="cb2-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># https://github.com/openai/openai-cookbook/blob/main/examples/How_to_count_tokens_with_tiktoken.ipynb</span></span>
<span id="cb2-21">encoder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tiktoken.get_encoding(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl100k_base"</span>)</span>
<span id="cb2-22">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_ids"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: encoder.encode(x))</span>
<span id="cb2-23">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_count"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_ids"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x))</span>
<span id="cb2-24">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tokens"</span>]  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_ids"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: encoder.decode_tokens_bytes(x))</span>
<span id="cb2-25">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_token_ratio"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_count"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_count"</span>]</span></code></pre></div>
</div>
</section>
<section id="計算" class="level2">
<h2 class="anchored" data-anchor-id="計算">計算</h2>
<p>まず、処理するデータの様子を実際に見てみましょう。</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ドキュメントのサンプル："</span>)</span>
<span id="cb3-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> txt_list[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]:</span>
<span id="cb3-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(i)</span>
<span id="cb3-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"..."</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ドキュメントのサンプル：
【DVDエンター！】誘拐犯に育てられた女が目にした真実は、孤独か幸福か
　2005年11月から翌2006年7月まで読売新聞にて連載された、直木賞作家・角田光代による初の長編サスペンス『八日目の蝉』。2010年に檀れいと北乃きいの出演によりテレビドラマ化された同作が、2011年4月に永作博美と井上真央の出演によって映画化。そして、劇場公開から半年が過ぎた10月28日、DVD＆ブルーレイとなって発売されました。

八日目の蝉
　妻子ある男と愛し合い、その子を身ごもりながら、あきらめざるをえなかった女。彼女は同時に、男の妻が子供を産んだことを知る。その赤ん坊を見に行った女は、突発的にその子を連れ去り、逃避行を続けた挙句、小豆島に落ち着き、母と娘として暮らしはじめる。


不倫相手の子供を誘拐し、4年間育てた女
　永作博美が演じる野々宮希和子は、不倫相手の子を宿しながらも、彼の「いずれ妻と別れるから、それまで待ってくれ」という常套句を信じて、中絶。後遺症により、二度と子供を産めない身体となってしまいます。その後、不倫相手から彼の妻が出産したことを知らされ、別れを決意。最後に諦めをつけるため、彼らの生後6ヶ月の赤ん坊・恵理菜の顔を見た希和子でしたが、自分に笑顔で向けた恵理菜を見て、思わず誘拐。名前を変えて恵理菜を薫と名付けると、人目を避けて各地を転々とし、二人で幸せな時間を過ごしますが、辿り着いた最後の場所・小豆島で4年の逃避行に終止符を打ちます。

...</code></pre>
</div>
</div>
<p>合計7,376件のドキュメントがあり、平均文字数は1,200文字程度です。</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1">df.word_count.describe().astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>count     7376
mean      1259
std        763
min         37
25%        730
50%       1069
75%       1602
max      12163
Name: word_count, dtype: int64</code></pre>
</div>
</div>
<p><span style="background-color: #FFFF00"> 文字数とトークン数の割合を見ると、以外に1文字が1トークンになっていることがわかります。 </span> また、この傾向が記事の種類によりますが、大きな違いはありません。</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1">df.word_token_ratio.mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>1.008244127016698</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1">df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"category"</span>).word_token_ratio.mean().sort_values().plot.barh(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>&lt;Axes: ylabel='category'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://jiang.jp/posts/20230505_tiktoken/index_files/figure-html/cell-7-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>これで文字数とトークン数の関係がわかることによって、ドキュメントを処理する課金を概算計算することができます。概算ロジックは以下と仮定します。</p>
<ul>
<li><p>インプットの長さは2000字とする。内訳は以下の通り。</p>
<ul>
<li><p>処理するドキュメントの長さは1000字とする。</p></li>
<li><p>タスクの説明や、処理の例は1000字とする。</p></li>
</ul></li>
<li><p>アウトプットは200字とする。</p></li>
<li><p>為替レートは1ドル=135円とする。</p></li>
</ul>
<p>これで計算すると1ドキュメントを処理するためには:</p>
<ul>
<li><p>スピードを求める<code>gpt-3.5-turbo</code>の場合は、0.002 * 2200 / 1000 * 135 = 0.59円 かかります。</p></li>
<li><p>性能を重視する<code>gpt-4-32k</code>を利用する場合は(0.03 * 2000 + 0.06 * 200) / 1000 * 135 = 9.7円 かかります。</p></li>
</ul>
</section>
<section id="tictokenの挙動" class="level2">
<h2 class="anchored" data-anchor-id="tictokenの挙動">TicTokenの挙動</h2>
<section id="bpeモデルが違う" class="level3">
<h3 class="anchored" data-anchor-id="bpeモデルが違う">BPEモデルが違う</h3>
<p>日本語は英語よりトークン数が多いと話している投稿は過去Twitterで見たことがあります。今回実際に計算してみると、日本語の1文字は大よそ1Tokenに等しいことがわかりました。それはDecodingするモデルが違うためです。</p>
<p>ここからはちょっと深い話をします。<code>TikToken</code>はBPE(Byte Pair Encoding)というデータ圧縮法に基づいて開発しました。コンピューターは文字を扱うことができないので、文字を数値に変換する必要があります。BPEは文字列をシンボルに置き換えることで、文字列を数値に変換します。BPEは頻繁に現れる文字のペアや、複数の文字を組み合わせたシンボルを生成します。それにより、入力するシーケンスの長さを短くすることができます。</p>
<p>例えば、“ab ab b”の文字列について、“ab”を0に、“b”を1に置き換えると、“0 0 1”という文字列になります。このように、BPEは文字列をシンボルに置き換えることで、もともと長さが7の文字列を長さが5のシーケンスに変換できました。</p>
<p>また、どの組み合わせをシンボルにするかはデータから学習することによって決められています。<code>gpt-3.5-turbo</code>と<code>gpt-4-32k</code>のモデルは以前のGPT3のモデルが違うので、Tokenizeした結果も違います。</p>
<p>実際の例を見ましょう。</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1">gpt4_encoder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tiktoken.encoding_for_model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gpt-4-32k"</span>)</span>
<span id="cb11-2">gpt3_encoder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tiktoken.encoding_for_model(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text-davinci-003"</span>)</span>
<span id="cb11-3"></span>
<span id="cb11-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GPT3のトークン数："</span>)</span>
<span id="cb11-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"こんにちは: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(gpt3_encoder.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'こんにちは'</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb11-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"GPT4のトークン数："</span>)</span>
<span id="cb11-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"こんにちは: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(gpt4_encoder.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'こんにちは'</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>GPT3のトークン数：
こんにちは: 6

GPT4のトークン数：
こんにちは: 1</code></pre>
</div>
</div>
<p>GPT3のToken数がGPT4より多いことがわかります。例えば、「こんにちは」はGPT3で6Tokenになりますが、GPT4では1Tokenになります。</p>
</section>
<section id="gptのbpeモデルは日本語をバイト化してからトークン化している" class="level3">
<h3 class="anchored" data-anchor-id="gptのbpeモデルは日本語をバイト化してからトークン化している">GPTのBPEモデルは日本語をバイト化してからトークン化している</h3>
<p>「こんにちは」については5文字はしかないですが、なぜ6Tokenになっているかに疑問を思うかもしれません。それはGPT3が多言語に対応するために、直接テキストで切っていなくて、日本語をまずバイトに変換して切っているからです。バイト化することにより違う言語でも共通のTokenで表現することができます。</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1">tokeinzer_result_byte <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gpt3_encoder.decode_tokens_bytes(gpt3_encoder.encode(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'こんにちは'</span>))</span>
<span id="cb13-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenize結果:"</span>, tokeinzer_result_byte)</span>
<span id="cb13-3">tokeinzer_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [i.decode() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(i) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> tokeinzer_result_byte ]</span>
<span id="cb13-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Decoding結果:"</span>, tokeinzer_result)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tokenize結果: [b'\xe3\x81\x93', b'\xe3\x82\x93', b'\xe3\x81\xab', b'\xe3\x81', b'\xa1', b'\xe3\x81\xaf']
Decoding結果: ['こ', 'ん', 'に', b'\xe3\x81', b'\xa1', 'は']</code></pre>
</div>
</div>
<p>上記の結果からわかることとしては、日本語1キャラクターは3バイトで表示しています。「こんにちは」の中の「ち」のみ2Tokenに分解されました。</p>
</section>
<section id="実際の比較" class="level3">
<h3 class="anchored" data-anchor-id="実際の比較">実際の比較</h3>
<p>つぎに、実際にデータでGPT3とGPT4のTokenizeの結果を比較してみましょう。</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_ids_gpt3"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: gpt3_encoder.encode(x))</span>
<span id="cb15-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_count_gpt3"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_ids_gpt3"</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x))</span>
<span id="cb15-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_token_ratio_gpt3"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"token_count_gpt3"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_count"</span>]</span>
<span id="cb15-4">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"word_token_ratio_gpt3"</span>].mean()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>1.317645208825121</code></pre>
</div>
</div>
</section>
</section>
<section id="まとめ" class="level2">
<h2 class="anchored" data-anchor-id="まとめ">まとめ</h2>
<p>過去にGPT3を使う場合は日本語のToken数は英語の2倍になる噂があります。GPTモデルで日本語のドキュメントを処理する際、1文字はおおよそ1トークンに等しいことがわかりました。千文字のドキュメントを処理するための概算コストは、スピード重視のgpt-3.5-turboを使う場合は0.59円、性能重視のgpt-4-32kを利用する場合は9.7円です。</p>
<p>また、GPT3とGPT4が使うTokenizerが違い、GPT3のトークン数はおおよそGPT4の1.3倍になります。</p>


</section>

 ]]></description>
  <category>NLP</category>
  <category>LLMs</category>
  <category>LangChain</category>
  <guid>https://jiang.jp/posts/20230505_tiktoken/index.html</guid>
  <pubDate>Thu, 04 May 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>InPars light 論文解読</title>
  <link>https://jiang.jp/posts/20230502_inpars_light/index.html</link>
  <description><![CDATA[ 



<p>InPars-lightは、無料で利用可能な言語モデルBLOOMをランキングモデルを使用し、1000個ではなく100個の候補レコードを再ランクしした。 先行研究の主要な知見を再現するだけでなく、Consistency checkingとAll-domain pre-trainingを組み合わせることで、非常に効率的で小型なモデルMiniLM-L6-30Mを訓練し、すべてのデータセットでBM25を上回る性能を達成した。最後に、大きなDeBERTA-v3-435Mモデルを使用して、7倍大きなMonoT5-3Bの性能をほぼマッチさせることができた。</p>
<p>論文URL：&lt;https://arxiv.org/abs/2301.02998&gt;</p>
<section id="introduction" class="level1">
<h1>1 Introduction</h1>
<p>IR領域でのニューラルモデルを学習させるためには、大量なラベリングしたデータが必要である。データラベリングのコストが非常に高い：Document-Queryのペアが関連するかを判断するには1分以上かかる。一個のQueryについては通常50件以上のドキュメントを見る必要がある。そのため、最近の研究は主にラベリングデータを生成することに集中している。</p>
<p>一方、今までの研究はお主にLLMsを使っていて、費用対効果が良くない。また、GPT3のようなLLMsはAPIのみアクセスしかできない。その2つの問題を解決するためには、この論文はInParsを再現し、改善を行った。</p>
<p>InParsがmonoT5-3Bとmonot5-220Mを使ったが、この論文は30MのLMと435MのDebertaを使って同等レベルの結果を得られた。Inparsは上位1000件のドキュメントをRerankしたが、この論文は100件のみRerankしている。</p>
<p>この論文は以下のResearch Questionを提起した：</p>
<ol type="1">
<li>情報検索（IR）能力は、単に大規模なnext-token-prediction学習から生まれるか。</li>
<li>データ生成においてOpen sourceのモデルは同じサイズのGPT3より劣るか。</li>
<li>一致性検査(Consistency checking)はほんとに有用か。</li>
<li>より小さいBertモデルでMonoT5-3Bを置換する場合は同じ性能を出せるか</li>
<li>30Mの小さいLMを使う場合はBM25に勝てるか。</li>
</ol>
<p>結果：</p>
<p>1&amp;2: BLOOMやGPT-JのようなOpen source LLMは同等サイズなGPT3より高性能の同時に、コストが1/10のみ。</p>
<p>3: 一致性検査はいつも有効である。</p>
<p>4&amp;5：InParsのやり方だと小さいモデルは使えない。一方、全部のデータゼットで前学習し、さらに生成したデータでFine-Tuningした30MのモデルがいつもBM25よりよい結果を出した。</p>
<section id="related-work" class="level2">
<h2 class="anchored" data-anchor-id="related-work">2 Related Work</h2>
<p>UPR: 3BのLLMをRerankとして使った。第一段階で取り出したドキュメントに対して”please write a question for this document”でQueyrを生成するLog probabiltyを計算し、それでRerankをしている。(LLMを学習させる際にLossの計算と同じやり方)</p>
<p>その他、InPars-v1、InPars-v2、Promptagator、HyDEが紹介された。以前の論文紹介で詳細を書いたため、今回は割愛する。</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">3 Methods</h2>
<p>この論文も2段階の検索を使った。まずBM25で大量なDocumentから関連するDocumentをフィルタリングする。そのつぎにニューラルモデルでRerankする。</p>
<p>RerankはCross-encoderを利用した。具体的に以下の3種類なものがある。</p>
<ol type="1">
<li>MiniLM-L6(30M)</li>
<li>ERNIE-v2(335M)</li>
<li>DeBERTA-v3(435M)</li>
</ol>
<p>ERNIEとDeBERTAを利用した理由としては、今2つのモデルはMS MARCOで強い結果を出したことがある。</p>
<p>Inparsと同じように各データセットに対して100kのQueryを生成した。生成したQueryとDocumentのペアでRerankerを学習させ、それを使ってConsistency checkingをした。Consistency checkingをする時に、生成したQueryで検索をかけて、生成元のDocumentがTop-Kにないとそれを捨てる。Kについては、1でも良いが、3のほうが精度が高かった。</p>
<p>また、面白いのは、Consistency checkingでフィルタリングしたデータとLog Probabilityでフィルタリングしたデータは20〜30%のみ共通している。</p>
<p>Rerankerを学習させる際に、まず生成した全データで学習させ、その上で、フィルタリングしたデータでFine-Tuningを行った。</p>
<p>この研究でMiniMLに対して、まずすべてのデータセットで生成したすべてのデータで学習し、さらにすべてのデータセットのフィルタリングしたデータでFine-Tuningしたが、過学習した。</p>
<p>実装する際に、FlexNeuARTのフレームワークを使った。モデルを学習させる際にInfoNCE Lossを使った。各Queryに対してNegative sampleを、BM25で検索できた上位1000件の中から3つサンプリングした。</p>
<p>各モデルについて、3つのSeedで3回学習し、結果の平均値をとった。結果の有意性のチェックはpaired two-sided t-testを使った。大きいデータセットだと0.01の閾値を使った。小さいデータセットだと、0.05の閾値を使った。</p>
<p>Promptの作り方はInParsが使った一般的なやり方と同じ。Queryを生成する際に、最大Token数を32に設定した。</p>
</section>
<section id="データセット" class="level2">
<h2 class="anchored" data-anchor-id="データセット">4 データセット</h2>
<p>InPars[4]の主要結果を再現するために、同じクエリとデータセットを使用した。MS MARCO以外のデータセットは「ir_datasets」というツールを利用して処理した。</p>
<p>InParsの論文で提供したGithubにGPT-3 Curieモデルで生成されたクエリと、それを生成するための文書が提供されている。これにより、GPT-3 CurieとオープンソースモデルGPT-J、BLOOMで生成されたQueryの品質を比較できる。クエリの生成コストがまだ高いため、他のオープンソースモデルの検討は将来の課題である。</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">5 Results</h2>
<section id="main-results" class="level3">
<h3 class="anchored" data-anchor-id="main-results">5.1 Main Results</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230502_inpars_light/images/paste-1.png" class="img-fluid figure-img" alt="main results"></p>
<figcaption class="figure-caption">main results</figcaption>
</figure>
</div>
<p><strong>BM25</strong> この論文は使うフィールドについて少し調整したが、InParsの結果と大きく変わらない。</p>
<p><strong>教師なし学習</strong> 今回使ったDeBERTA-v3-435Mは以前のMonoT5-3Bの性能と同じ。また今回提案したMiniLM-L6-30MはInParsのものT5-220M相当な性能を出している。</p>
<p><strong>Consistency checkingとall-domain pre-training</strong> 両方とも良い影響を与えることがわかる。Deberta-v3-435Mに対してAll-domain pre-trainingが逆効果があるが、理由が不明。</p>
<p><strong>教師あり学習</strong> 今回提案した2つのモデルの性能がいまいち。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230502_inpars_light/images/paste-3.png" class="img-fluid figure-img" alt="model performance"></p>
<figcaption class="figure-caption">model performance</figcaption>
</figure>
</div>
<p>Queryを生成するLLMモデルの比較について、オープンソースのGPT-JとBLOOMはOpen AI Curieよりよい性能を出している。</p>
<p>また、Rerankerについては、Deberta-v3-435MはERNIE-v2-335Mよりよいことがわかる。</p>
</section>
<section id="cost-and-efficiency" class="level3">
<h3 class="anchored" data-anchor-id="cost-and-efficiency">5.2 Cost and Efficiency</h3>
<p>RTX3039を使う場合は：</p>
<ol type="1">
<li>MiniLM-L6-30Mの推論のThroughputは1秒500ドキュメント(LLM各ドキュメントの長さは477キャラクター以下)、そのため、100ドキュメントをRerankする場合は1秒かからない。</li>
<li>MiniLM-L6-30Mを全データセットで前学習しても2時間しかかからない。一方、Deberta-v3-435Mは28時間かかる。</li>
<li>all-domain pre-trainingをする際に、一番時間がかかる操作はMS MARCOのような大きいなデータセットのバリデーションとConsistency checking。Deberta-v3-435MでMS MARCOでのバリデーション時間は6時間、Consistency checkingだと48時間かかった。</li>
<li>Query生成の時間：100kのQueryを生成するためには15時間がかかる。</li>
</ol>
</section>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>
</section>

 ]]></description>
  <category>NLP</category>
  <category>Information_retrieval</category>
  <category>paper</category>
  <guid>https://jiang.jp/posts/20230502_inpars_light/index.html</guid>
  <pubDate>Mon, 01 May 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>InPars V2 論文解読</title>
  <link>https://jiang.jp/posts/20230501_inpars_v2/index.html</link>
  <description><![CDATA[ 



<p>InPars V2論文では、Query生成に使用するLLMがGPT3からオープンソースのGPT-J(6B)に変更され、生成したQueryのフィルタリング方法がLog Probabilityからmonot5(3B)をRerankerとして利用する方法に変更された点を挙げている。実験結果としては、V2の精度がV1と比べてわずかに向上したことが報告されている。</p>
<p>論文URL：<a href="https://arxiv.org/abs/2301.01820" class="uri">https://arxiv.org/abs/2301.01820</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1 Introduction</h2>
<p>InPars v1とv2の違いは、主に以下の2点：</p>
<table class="table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Difference</th>
<th>InPars v1</th>
<th>InPars v2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Queryを生成するLLM</td>
<td>GPT3</td>
<td>GPT-J(6B) (オープンソース)</td>
</tr>
<tr class="even">
<td>生成したQueryのフィルタリング方法</td>
<td>生成時のLog Probabilityでフィルタリング</td>
<td>monot5(3B)をRerankerとしてフィルタリング</td>
</tr>
</tbody>
</table>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">2 Methodology</h2>
<p>BEIRの各データセットに対して100kのドキュメントをサンプリングする。MS MARCOからの3つの例を利用してGBQの形式でPromptを作成し、各ドキュメントに対して一個のQueryを生成する。GPT-J(6B)を利用してQueryを生成した。A100一枚で100kのQueryを生成するためには30時間かかる。</p>
<p>フィルタリングについては以前は生成時のLog Probabilityが上位の10kのペアを選んだが、今回はMS-MARCOでFine-tuningしたものT5-3BをRerankerとして使った。100kのQueryとDocumentのペアについて相関度を出して、上位の10kペアを利用した。</p>
<p>Negative sampleはまた各QueryについてBM25で上位1000ドキュメント中で1個ランダム選んだ。</p>
</section>
<section id="result" class="level2">
<h2 class="anchored" data-anchor-id="result">3 Result</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230501_inpars_v2/images/paste-1.png" class="img-fluid figure-img" alt="result" width="500"></p>
<figcaption class="figure-caption">result</figcaption>
</figure>
</div>
<p>実験結果を見ると、v2はv1と比べて精度が少し良くなった(0.006)。</p>


</section>

 ]]></description>
  <category>NLP</category>
  <category>Information_retrieval</category>
  <category>paper</category>
  <guid>https://jiang.jp/posts/20230501_inpars_v2/index.html</guid>
  <pubDate>Sun, 30 Apr 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>HyDE 論文解読</title>
  <link>https://jiang.jp/posts/20230430_HyDE/index.html</link>
  <description><![CDATA[ 



<p>HyDE論文では、教師なしのZero-shot dense retrievalシステムを提案。従来のDense retrieverとは異なり、HyDEはQueryから仮想的なDocumentを生成し、その類似度でランキング。InstructGPTで仮想ドキュメントを生成し、Contrieverを使ってEmbeddingに変換。様々なデータセットでテストした結果、HyDEは教師なし領域で従来のContrieverを凌駕し、教師ありモデルとも遜色ない精度を示した。実装はLangChainで利用可能。</p>
<p>論文URL：<a href="https://arxiv.org/abs/2204.07496" class="uri">https://arxiv.org/abs/2204.07496</a></p>
<section id="introduction" class="level1">
<h1>1 Introduction</h1>
<p>Dense retrievalについて様々な研究が行われているが、Zero-shot dense retrievalはまだ難しい。多くの研究はMS-MARCOのような大規模なデータセットを使って転移学習をしているが、MS-MARCOが商用不可の制限があるし、他のドメインに汎化が難しい課題がある。一方、新たなデータをラベリングするためには莫大なコストがかかる。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230430_HyDE/images/paste-1.png" class="img-fluid figure-img" alt="HyDE"></p>
<figcaption class="figure-caption">HyDE</figcaption>
</figure>
</div>
<p>この論文では教師なしのZero-shot dense retrievalの仕組HyDEを提案した。 従来のDense retrieverはQueryとDocumentとの類似度でランクを決めている。HyDEはQueryを利用して、まずLLMでそのQueryを答える仮想なDocumentを生成する。生成したDocumentとDocumentの類似度でランキングしている。</p>
<section id="related-works" class="level2">
<h2 class="anchored" data-anchor-id="related-works">2 Related works</h2>
</section>
<section id="methology" class="level2">
<h2 class="anchored" data-anchor-id="methology">3 Methology</h2>
</section>
<section id="experiments" class="level2">
<h2 class="anchored" data-anchor-id="experiments">4 Experiments</h2>
<p>仮想なDocumentはInstructGPTで生成した。生成したDocumentをContrieverを用いてEmbeddingに変換した。</p>
<p>テストのデータとしては、MS-MARCOをベースとしたTREC DL19 DL20があり、BEIRからもLow-resourceのデータセットをいくつ利用した。また、英語以外、韓国語、日本語等データセットも使った。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230430_HyDE/images/paste-2.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">web search query sets</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230430_HyDE/images/paste-4.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">low-resource datasets</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230430_HyDE/images/paste-5.png" class="img-fluid figure-img" width="400"></p>
<figcaption class="figure-caption">non-English retrieval</figcaption>
</figure>
</div>
<p>結果を見ると、教師なしの領域でHyDEは全面的に以前のContrieverを超えた。また、教師あるのモデルから比較しても遜色しない精度を出した。</p>
</section>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">5 Analysis</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230430_HyDE/images/paste-6.png" class="img-fluid figure-img" alt="LLM difference" width="300"></p>
<figcaption class="figure-caption">LLM difference</figcaption>
</figure>
</div>
<p>当たり前だが、仮想なドキュメントを生成するLLMによって最終の精度が違う。また、HyDEは教師なしの手法だが、教師ありのRetrieverの精度も向上できる。</p>
</section>
<section id="実装" class="level2">
<h2 class="anchored" data-anchor-id="実装">実装</h2>
<p>HyDEはすでに<a href="https://python.langchain.com/en/latest/modules/chains/index_examples/hyde.html">LangChain</a>で実装されている。</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.llms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAI</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.embeddings <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> OpenAIEmbeddings</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> langchain.chains <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> HypotheticalDocumentEmbedder</span>
<span id="cb1-4"></span>
<span id="cb1-5">base_embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAIEmbeddings()</span>
<span id="cb1-6">llm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> OpenAI()</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load with `web_search` prompt</span></span>
<span id="cb1-9">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> HypotheticalDocumentEmbedder.from_llm(llm, base_embeddings, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"web_search"</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Now we can use it as any embedding class!</span></span>
<span id="cb1-12">result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embeddings.embed_query(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Where is the Taj Mahal?"</span>)</span></code></pre></div>


</section>
</section>

 ]]></description>
  <category>NLP</category>
  <category>Information_retrieval</category>
  <category>paper</category>
  <guid>https://jiang.jp/posts/20230430_HyDE/index.html</guid>
  <pubDate>Sat, 29 Apr 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Promptagator 論文解読</title>
  <link>https://jiang.jp/posts/20230429_promptagator/index.html</link>
  <description><![CDATA[ 



<p>Promptagator論文では、Few-shot Retrieval settingを提案し、異なる検索タスクに対応するために専用のPromptを作成してLLMでDocumentに関連するQueryを生成。生成されたQueryをフィルタリングし、Retrieverを学習させる。実験結果から、Promptagatorは既存の50万件以上の学習データを使ったモデルより高い精度を達成し、教師ありのRetrieverよりも優れていることが分かった。</p>
<p>論文URL：<a href="https://arxiv.org/abs/2209.11755" class="uri">https://arxiv.org/abs/2209.11755</a></p>
<section id="introduction" class="level1">
<h1>1 Introduction</h1>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-7.png" class="img-fluid figure-img" alt="Few-shot retrieval with PROMPTAGATOR" width="700"></p>
<figcaption class="figure-caption">Few-shot retrieval with PROMPTAGATOR</figcaption>
</figure>
</div>
<p>BEIRのような異なる種類のデータセットによって構成されるベンチマークがある。特定のデータセットで学習したモデルは他領域への汎化が難しい。その理由は主に2つある。</p>
<p>まず、異なるタスクはそれぞれ検索意図が違う。例えば、図1の左側に示されているように、Dbpedia-Entityはクエリで言及されたエンティティを検索するタスクであり、FEVERは与えられた声明を支持または反証する証拠を検索するタスクである。</p>
<p>また、検索意図が類似していても、データの分布が異なることがある。例えば、HotpotQAのように違う領域の質問もあるし、FiQAのようにファイナンシャル専門の質問もある。</p>
<p>これまでに、情報検索領域でのLLMの活用に関する論文が複数ある。例えば、GPT3のEmbedingをDual encoderモデルに適用する論文がある。ただし、GPT3のEmbeddingの次元数が12ｋとなっており、推論時の計算コストが高い。また、以前紹介したGPT3でQueryを作って、T5のRerankerを学習したInParsもある。一方、その論文はRetrieverをBM25を使っている。</p>
<p>この論文は以下の貢献がある：</p>
<ol type="1">
<li>異なる検索タスクの意図とQueryの分布を分析し、Few-shot Retrieval settingを提案した。</li>
<li>Promptgatorを提案した。2~8個の例を使えば既往の50万以上の例で学習したモデルより高い精度を達成できている。</li>
</ol>
</section>
<section id="few-shot-retrieval-task" class="level1">
<h1>2 Few-shot retrieval task</h1>
<p>この節でFew-shot retrievalを紹介した。</p>
</section>
<section id="promptagator" class="level1">
<h1>3 Promptagator</h1>
<p>Promptagatorは3つのステップで実現される。</p>
<ol type="1">
<li>各タスクに対して専用なPromptを作成し、LLMでDocumentに関連するQueryを作る</li>
<li>Retrieverを用いて、生成したQueryと生成元のDocumentを検索できない場合は、それを除外する</li>
<li>除外されていないQueryとDocumentのペアでRetrieverを学習させる。</li>
</ol>
<section id="prompt-base-query-generation" class="level2">
<h2 class="anchored" data-anchor-id="prompt-base-query-generation">3.1 Prompt-base query generation</h2>
<p>LLMはFLANを利用した。Promptの形式としては、HotpotQAを例として説明すると以下になる。</p>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode numberSource raw text number-lines code-with-copy"><code class="sourceCode"><span id="cb1-1">Evidence: passage 1 </span>
<span id="cb1-2">Vexed question: query 1</span>
<span id="cb1-3">...</span>
<span id="cb1-4">Evidence: passage k</span>
<span id="cb1-5">Vexed question: query k</span>
<span id="cb1-6">Evidence: target passage</span></code></pre></div>
<p>下表のようにタスクごとに違うPromptを設定した。（Promptの中の0と 1の意味が不明）</p>
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-8.png" class="img-fluid" alt="Prompt template for each dataset"><br>
Promptで使用した例は最大8個にし、例の長さによって調整している。文書が長い場合は、必要に応じて切断している。</p>
<p>各コーパスから最大100万のドキュメントを抽出し、各ドキュメントで8個のQueryを生成している。LLMはFLAN137Bを使った。生成する際に0.7の温度を使った。</p>
</section>
<section id="consistency-filtering-using-only-generated-data" class="level2">
<h2 class="anchored" data-anchor-id="consistency-filtering-using-only-generated-data">3.2 Consistency filtering using only generated data</h2>
<p>生成したQueryに対して、生成元がその答案を含む必要がある。今までの研究で、その原則で生成したQueryをフィルタリングすることは重要であることがしめされている。</p>
<p>過去の研究の中で外部の質問応答モデルを用いて実現していたが、この研究では生成したデータで初期のRetrieverを学習されている。各生成したQueryに対して、Retrieverが検索したTopKの中に生成元のドキュメントが含まれていない場合は、そのQueryを除外する。</p>
</section>
<section id="few-shot-promptagator-retriever" class="level2">
<h2 class="anchored" data-anchor-id="few-shot-promptagator-retriever">3.3 Few-shot promptagator retriever</h2>
<p>Dural EncoderのRetrieverを利用している。ベースモデルはT5で、それをC4（Common Crawlのweb crawlコーパス）データセットを使って、Contriverが使用したindependent cropping taskでさらに学習させた。（independent cropping taskとは、同じ文書の異なる部分のペアをPositive example、異なる文書のテキストのペアをNegative exampleとして、教師なしでRetrieverを学習する手法）</p>
<p>その後、生成されたQueryとDocumentのペアを使って継続的に学習させる。学習時にBatch内のQueryとDocumentのペアをシャッフルしてNegative exampleとする。また、一定のStep数を学習した後、それを初期のRetrieverとして生成されたQueryのフィルタリングを行う。フィルタリングした後、継続的に学習させる。</p>
<p>また、Promptagator++というRerankerも提案した。学習データがRetrieverと同じだが、モデルはもっと精度が高く、推論時間が長いCross-attention modelを使った。Retrieverから取得した上位の200件のDocumentから31個のDocumentをサンプリングして、Negative exampleとして使っている。</p>
</section>
<section id="zero-shot-promptagator-retriever" class="level2">
<h2 class="anchored" data-anchor-id="zero-shot-promptagator-retriever">3.4 Zero-shot promptagator retriever</h2>
<p>Zero-shotでQueryを生成する場合は以下の形式でPromptを書いた：</p>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> Read the passage and generate a query.'</span></span></code></pre></div>
</section>
</section>
<section id="experiments" class="level1">
<h1>4 Experiments</h1>
<section id="implementation" class="level2">
<h2 class="anchored" data-anchor-id="implementation">4.1 Implementation</h2>
<p>Queryを生成する際に温度を0.7にした。</p>
<p>生成したQueryをフィルタリングする際にKを1にした。</p>
<p>Dual Encodersは同じT5-base v1.1 のEncoder(110M)を使っている。Encoderのトップの層を平均し、768次元のEmbeddingへ投影した。</p>
<p>Promptagator++のRerankerもT5-base v1.1 のEncoder(110M)を使っているが、Cross AttentionのEncoderにしている。</p>
<p>Fine-tuningする際にの具体的なBatch sizeとStepsが下表の通り：</p>
<table class="table">
<thead>
<tr class="header">
<th>Model type</th>
<th>Dataset size</th>
<th>Batch size</th>
<th>Fine tune steps</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Dual encoder</td>
<td>Big(&gt;500k)</td>
<td>6k</td>
<td>5k</td>
</tr>
<tr class="even">
<td>Dual encoder</td>
<td>Small(&lt;=500k)</td>
<td>128</td>
<td>1k</td>
</tr>
<tr class="odd">
<td>Reranker</td>
<td>Big(&gt;500k)</td>
<td>64</td>
<td>20k</td>
</tr>
<tr class="even">
<td>Reranker</td>
<td>Small(&lt;=500k)</td>
<td>64</td>
<td>5k</td>
</tr>
</tbody>
</table>
</section>
<section id="main-results" class="level2">
<h2 class="anchored" data-anchor-id="main-results">4.2 Main Results</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-9.png" class="img-fluid figure-img" alt="Main result"></p>
<figcaption class="figure-caption">Main result</figcaption>
</figure>
</div>
<p>表の前半ではRetrieverの比較が行われている。Zero-shotのPromptagatorはすでに大多数のMS MARCOでFine-tuningした教師ありのRetrieverと同等な精度を出している。Few-shotのPromptagatorはさらに教師ありのRetrieverより高い精度を出している。</p>
<p>後半ではRetriever+Rerankerの組み合わせの比較になる。Retrieverと同じ傾向で、Zero-shotでかなり良い精度を出している。Few-shotになるとさらに更に精度が3%向上し、Sotaになっている。</p>
<p>また、Promptagatorのもう一つ優れている点はモデルのサイズである。他のモデルは大体3Bの大きさだが、Promptagatorはわずか110Mのみである。</p>
</section>
<section id="abalation-study" class="level2">
<h2 class="anchored" data-anchor-id="abalation-study">4.3 Abalation Study</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-10.png" class="img-fluid figure-img" alt="Abalation study"></p>
<figcaption class="figure-caption">Abalation study</figcaption>
</figure>
</div>
<p><strong>Queryフィルタリングの効果</strong> Figure2の左図は、Queryを一回フィルタリングした効果をしめしている。大多数のデータセットにとって、Queryフィルタリングが有効だが、逆効果のものも存在する。NFCorpus and SciFactは小さいデータセットなので、フィルタリングで過学習している可能性がある。</p>
<p>また、詳細にフィルタリングされた例をみると、多くケースはQueryは一般化過ぎて多数のドキュメントにマッチングされていること、もしくは単純にQueryが間違っていることがわかる。</p>
<p><strong>生成したQueryで人間のデータを代替することができるか？</strong> Figure2の真ん中の図は、8-shotのPromptagatorは5万件の人間がラベリングしたデータと同じ効果であることを示している。</p>
<p><strong>PromptagatorのQuery生成が効いているか？</strong> Figure2の右図のGenQはBEIR論文の中で提案されたモデル、NQ-QGenはこの論文提案した方法でNQデータセット学習したモデル、NQ-QGenとGenQの違いはQuery生成の部分のみ。NQ-QGenの精度は2.7%高いため、提案したQuery生成の方法が有効だと言える。</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-6.png" class="img-fluid figure-img" alt="Impact of FLAN"></p>
<figcaption class="figure-caption">Impact of FLAN</figcaption>
</figure>
</div>
<p><strong>FLANの影響</strong> PromptagatorのLLMはFLANを利用している。FLANの学習データの中にNQとQuaroデータが含まれいている。その影響を検証するため､それらを除いたデータセットでFLANを学習し、その結果を比較した(さすがGoogle Research、金ならあるの感じ)。その結果、精度は若干低下したが、以前の研究よりは高い精度を達成している。</p>
</section>
<section id="qualitative-analysis" class="level2">
<h2 class="anchored" data-anchor-id="qualitative-analysis">4.4 Qualitative Analysis</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230429_promptagator/images/paste-5.png" class="img-fluid figure-img" alt="Top word distribution"></p>
<figcaption class="figure-caption">Top word distribution</figcaption>
</figure>
</div>
<p>Queryの最初のWordの分布を調査した。Few-shotが生成したQueryの分布は実際のQueryの分布と同じであることがわかる。</p>
</section>
</section>
<section id="related-work" class="level1">
<h1>5 Related Work</h1>
<section id="neural-retrieval-models" class="level2">
<h2 class="anchored" data-anchor-id="neural-retrieval-models"><strong>Neural retrieval models</strong></h2>
<p>Neural retrieval modelはrepresentation based modelとinteraction based modelの2つに分類できる。</p>
<p>Representation based modelはQueryとDocument両方とも分散表現に変換し、分散表現の類似度で相関性を測っている。最近の研究は以下のことにフォーカスしている：</p>
<ol type="1">
<li>より良い前学習するタスクやモデルのアーキテクチャを開発する</li>
<li>Multi-Vectorでより分散表現の表現性能を向上させる</li>
<li>よりよいNegative sample手法を開発する</li>
<li>ドメイン横断での汎化性能を向上させる</li>
</ol>
<p>Interaction based modelだと、QueryとDocumentを一緒に処理するため、精度が高い。一方、計算コストが高いため、Rerankerとして使われることが多い。それに関する研究は以下のものがある：</p>
<ol type="1">
<li>Interaction based modelを蒸留し、Representation based modelとして使う。</li>
<li>Interactionを最後にさせること。</li>
</ol>
</section>
<section id="prompt-based-query-generation" class="level2">
<h2 class="anchored" data-anchor-id="prompt-based-query-generation">Prompt-based query generation</h2>
<p>UPR：直接LLMSを使ってRerankを行う</p>
<p>InPars：GPT3でQueryを生成し、T5のRerankerを学習する</p>
</section>
<section id="retrievers-with-late-interactions" class="level2">
<h2 class="anchored" data-anchor-id="retrievers-with-late-interactions">Retrievers with late interactions</h2>
<p>Dual encoder modelの効率が良いが、QueryとDocumentの相互作用は最後の内積のみであるため、性能が弱い。ColBERTとSPLADEは最後のToken-level interactionを使ったため、計算コストを少し犠牲して性能を向上させた。</p>
</section>
</section>
<section id="conclution-and-discussions" class="level1">
<h1>6 Conclution and discussions</h1>
<p>この論文はPromptagatorを提案した。一方、未解決の問題はいかのように存在する：</p>
<ol type="1">
<li>効率的に生成したデータを利用する手法が必要。</li>
<li>PromptとRetrieverの性能との関係。</li>
<li>LLMの情報を小さいモデルを転移すること。</li>
</ol>


</section>

 ]]></description>
  <category>NLP</category>
  <category>Information_retrieval</category>
  <category>paper</category>
  <guid>https://jiang.jp/posts/20230429_promptagator/index.html</guid>
  <pubDate>Fri, 28 Apr 2023 15:00:00 GMT</pubDate>
</item>
<item>
  <title>InPars 論文解読</title>
  <link>https://jiang.jp/posts/20230428_inpars/index.html</link>
  <description><![CDATA[ 



<p>InPars論文では、擬似データ（Pseudo data）生成によるランキングモデル学習手法を提案。LLMを用いて擬似データを生成し、それを使ってモデルを学習させることで、情報検索（IR）の精度を向上させる。実験では、生成された擬似データでMonoT5をFine-tuningし、結果として従来のUnsupervisedモデルより優れた性能を示した。</p>
<p>論文URL：<a href="https://arxiv.org/abs/2202.05144" class="uri">https://arxiv.org/abs/2202.05144</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">1. Introduction</h2>
<p>LLMは高性能を誇るものの、情報検索（IR）への応用が制限されている理由として、大規模な計算量が必要であることと、コストが高いことが挙げられる。GPT-3の埋め込みサービスを利用する場合、すべてのテキストを少なくとも1回は処理する必要があり、件数が多い場合、コストが膨大になることが問題となる。</p>
<p>また、学習データにも課題が存在し、現存するデータが商用利用に適さないものが多く、また、既存のデータを用いて学習したモデルが他の領域に汎用性を持たないという問題がある。</p>
<p>この論文では、検索推論にLLMを直接使用するのではなく、LLMを用いて擬似データ（Pseudo data）を生成し、そのデータを使ってランキングモデルを学習する手法を提案している。</p>
</section>
<section id="related-work" class="level2">
<h2 class="anchored" data-anchor-id="related-work">2. Related work</h2>
<p>これまで情報検索（IR）領域におけるデータ生成の研究では、BM25を用いて類似度が高いドキュメントをペアとしてモデルを学習する研究が存在する。また、教師ありのモデルでテキストからQueryを生成し、それとテキストのペアを学習データとする研究もあった。</p>
<p>この研究の特徴として、モデルを学習させなく、LLMからFew-shotでデータを生成したこと（ちょっと新奇性が足りていない気がする）。</p>
</section>
<section id="our-method-inpars" class="level2">
<h2 class="anchored" data-anchor-id="our-method-inpars">3. Our Method: InPars</h2>
<p>以下はInParsのステップ：</p>
<ol type="1">
<li><p>複数のドキュメントとクエリーのペアが存在すると仮定する。それを例として、Few-shotでLLMでドキュメントに関連するクエリーを生成してもらう。(</p>
<p>詳細は4.2で紹介する）</p></li>
<li><p>生成したドキュメントとクエリーのペアについて、LLMが出力する際に出している結果のLog probabilityが上位のものを選択する。ちなみに、このステップが大きく精度を改善した。</p></li>
<li><p>生成したqとdのペアを学習データとしてRerankのモデルをFine-tuningする。（詳細は4.3で紹介する）</p></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230428_inpars/images/paste-1.png" class="img-fluid figure-img" alt="InPars "></p>
<figcaption class="figure-caption">InPars</figcaption>
</figure>
</div>
</section>
<section id="experimental-setup" class="level2">
<h2 class="anchored" data-anchor-id="experimental-setup">4. Experimental Setup</h2>
<section id="datasets" class="level3">
<h3 class="anchored" data-anchor-id="datasets">4.1 Datasets</h3>
<p>今回使用したデータセットは以下：</p>
<ul>
<li><p>MS MARCO：Microsoftが出したBingの実際のユーザログをベースとした大型データセット。880万のドキュメントと50万のドキュメントとクエリーのペアがある。各クエリーが平均的に1ドキュメントに対応する。</p></li>
<li><p>TREC-DL：MS MARCOと同じドキュメントを持っているが、クエリーは54件のみである。また、各クエリーについてアノテーションしたドキュメントが多い。</p></li>
<li><p>Robust04：新聞領域のデータセット。52万のドキュメントがあり、249クエリーがある。各クエリーに対して、平均的に1250件のドキュメントをアノテーションした。</p></li>
<li><p>Natural Questions：260万件のWikipediaテキストをベースとしたQuestion Answer データセット。QuestionはGoogleの検索エンジンのログから作ったもの。</p></li>
<li><p>TREC-COVID：コロナの情報に関するデータセット</p></li>
</ul>
</section>
<section id="training-data-generation" class="level3">
<h3 class="anchored" data-anchor-id="training-data-generation">4.2 Training Data Generation</h3>
<p>各学習データは（Query, Positive document, Negative document）のTripleによって構成させる。その生成のステップは以下：</p>
<ul>
<li><p>10万のドキュメントをサンプリングし、GPT3のCurieでQueryを生成させる。</p></li>
<li><p>最終的にLog probabilityが上位の1万件のペアのみ学習データとして使う。</p></li>
<li><p>BM25で検索した1000件の中でランダムに1件を抽出し、それをNegative Documentとする。（このやり方で多くのノイズを入れてしまうのでは？）</p></li>
</ul>
<p>以下は２点の補足：</p>
<ul>
<li><p>生成する際に温度とTopーPのパラメータ設定は結果に有意の影響しない。</p></li>
<li><p>長さが300文字のドキュメントは捨てられる。</p></li>
</ul>
<p>Query生成する際にPromptの書き方は2つを利用した（Figure２)：</p>
<ol type="1">
<li>一般方法（Vanilla)：MS MARCOからランダムに3つのデータを抽出し、それを例として、FewーshotでQueryを生成させる。</li>
<li>GBQ（Guided by Bad Questions）：一般方法と同じように、MS MARCOからランダムに3つのデータを抽出する。しかし、MS MARCOのQueryが漠然すぎるため、それをBad questionとして提示する。Documentを読んで、より関連するGood Questionを手動で作った。（Document, Good Question, Bad Question)で例を提示し、生成したGood QuestionをQueryとする。</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://jiang.jp/posts/20230428_inpars/images/paste-2.png" class="img-fluid figure-img" alt="Prompt example"></p>
<figcaption class="figure-caption">Prompt example</figcaption>
</figure>
</div>
</section>
<section id="retrieval-methods" class="level3">
<h3 class="anchored" data-anchor-id="retrieval-methods">4.3 Retrieval Methods</h3>
<p>２段階の検索を採用している。まずBM25で上位1000のドキュメントを取り出す。その次、MonoT5を使ってRerankingをする。</p>
<p>MonoT5はTransformerのEncoderとDecoder両方とも使っているモデルで、Cross-Encoderモデルである。今回の実験では、サイズは220Mと3Bのモデルでテストした。</p>
<p>各データセットにおいて作成された擬似データでMonoT5をFine-tuningした。</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">5 Results</h2>
<p><img src="https://jiang.jp/posts/20230428_inpars/images/Snipaste_2023-05-01_09-49-20.png" class="img-fluid"></p>
<p>7,8行目を見ると、BM25やContriever等の以前のUnsupervised結果より優れていることがわかる。また、16行目はMS MARCOでFine-tuningした後さらに擬似データでFine-tuningした結果。幾つかのデータセットで単純にMS MARCOでFine-tuningするより良い結果が出ている。</p>
</section>
<section id="ablation-study-and-analysis" class="level2">
<h2 class="anchored" data-anchor-id="ablation-study-and-analysis">6 Ablation Study and Analysis</h2>
<p>6.1 Prompt Selection and Source Corpus</p>
<p>比較対象が混乱のため、何が言いたいかがわからなかった。</p>
<p>6.2 Model Size Impact on IR Metrics</p>
<p>当たり前だけど、Questionを生成するモデルのサイズが大きいほど結果がよくなる。</p>
<p>6.3 Filtering by the Most Likely Questions</p>
<p>Top1万件のデータを利用することにより精度が向上した。</p>
<p>6.4 Was GPT-3 Trained on Supervised IR Data?</p>
<p>生成したQuestionがどのぐらい実際のMS MARCOデータにあるかで、GPT3の学習データにMS MARCOのデータを含まれているかを検証した。結果としては多くても10％前後のため影響がない。（検証のやり方が正しいかが疑問）</p>
</section>
<section id="conclusion-and-future-work" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-future-work">7 Conclusion and Future Work</h2>
<p>本文は、LLMを利用してQueryを生成して、生成したQueryとドキュメントのペアを学習データでモデルを学習する手法を提案した。</p>
<p>今後の改善点としては、</p>
<ol type="1">
<li>擬似データでDense RetrieverをFine-tuningする（今回はRerankerのみ）</li>
<li>データを生成する際に作った”BAD question”をNegative exampleとして使用する</li>
<li>擬似データの数を増やす</li>
<li>（Query, Document)のペアを探すもっと良い手法を開発する</li>
</ol>


</section>

 ]]></description>
  <category>NLP</category>
  <category>Information_retrieval</category>
  <category>paper</category>
  <guid>https://jiang.jp/posts/20230428_inpars/index.html</guid>
  <pubDate>Fri, 28 Apr 2023 15:00:00 GMT</pubDate>
</item>
</channel>
</rss>
